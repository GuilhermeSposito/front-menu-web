@rendermode RenderMode.InteractiveWebAssembly
@attribute [Authorize]
@page "/nfs-estatisticas"
@inject IJSRuntime JS
@using FrontMenuWeb.Components.Modais.ModaisDeCadastros.Funcionarios
@using FrontMenuWeb.Components.Modais.ModaisDePessoas
@using FrontMenuWeb.Components.Uteis
@using FrontMenuWeb.DTOS
@using FrontMenuWeb.Models.Merchant
@using FrontMenuWeb.Models.Pessoas
@using FrontMenuWeb.Services
@using FrontMenuWeb.Services.Fiscal
@using Microsoft.AspNetCore.Components
@using System.Globalization;
@using MudBlazor.Extensions
@using MudBlazor.Services
@using MudBlazor.Extensions.Components
@using MudBlazor.Extensions.Services
@inject NfService NfService
@inject PedidosService PedidosService

<MudPaper Square="false" Elevation="0" Style="background-color: var(--mud-palette-background); min-height: 100vh; margin-top:10px">
    <MudLayout>
        <MudStack Class="w-100 p-2 rounded-3" Style="background-color: var(--mud-palette-surface);">
            <MudStack>
                <MudText Typo="Typo.h4">NF-e NFC-e</MudText>
                <MudText Class="mb-3" Typo="Typo.body1">NF-e NFC-e Emitidas (Posição Físcal)</MudText>
            </MudStack>
        </MudStack>

        <MudStack Class="w-100 p-3 rounded-2 mt-2" AlignItems="AlignItems.Center" Justify="Justify.FlexStart" Style="background-color: var(--mud-palette-surface)">
            <MudTabs Class="w-100" ActivePanelIndexChanged="AtualizarPeriodoRapido" Rounded="true" Centered="true" Color="Color.Primary">
                <MudTabPanel Text="Mês Passado" />
                <MudTabPanel Text="Semana Passada" />
                <MudTabPanel Text="Hoje" />
                <MudTabPanel Text="Esta Semana" />
                <MudTabPanel Text="Semana Que Vem" />
                <MudTabPanel Text="Este Mês" />
            </MudTabs>

            <MudStack Class="w-100 p-3 rounded-2 mt-2" Row="true" AlignItems="AlignItems.Center" Justify="Justify.FlexStart" Style="background-color: var(--mud-palette-surface)">
                <MudDatePicker @bind-Date="FiltroDateTimeInicial" Label="Data Inicial" Placeholder="Escolha Uma Data Inicial" />
                <MudDatePicker @bind-Date="FiltroDateTimeFinal" Label="Data Final" Placeholder="Escolha Uma Data Final" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AplicarFiltros">Aplicar Filtros</MudButton>
                @if (FiltroDateTimeFinal is not null && FiltroDateTimeInicial is not null)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LimparFiltros">Limpar Filtros</MudButton>
                }
            </MudStack>

        </MudStack>

        <MudDataGrid T="NFEmitidasDto"
                     @ref="dataGridRef"
                     EditTrigger="DataGridEditTrigger.Manual"
                     MultiSelection=false
                     Class="rounded-3 custom-striped mt-2"
                     Loading="Carregando"
                     Hover
                     HorizontalScrollbar="false"
                     ServerData="LoadServerData">
            <NoRecordsContent>
                <AvisoDeDadosVazios ReferenciaDados="NF-e NFC-e" />
            </NoRecordsContent>
            <Columns>
                <PropertyColumn Property="x => x.Id" Title="Id"></PropertyColumn>
                <TemplateColumn T="NFEmitidasDto" Title="Tipo">
                    <CellTemplate Context="context">
                        <MudText Style="font-weight:600" Color=@(context.Item.NfTipo == 55 ? Color.Success : Color.Error)>@(context.Item.NfTipo == 55 ? "NF-e" : "NFC-e")</MudText>
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.NmrNf" Title="Nmr da NF"></PropertyColumn>
                <TemplateColumn T="NFEmitidasDto" Title="Nmr do Protocolo">
                    <CellTemplate Context="context">
                        @if (context.Item.NmrProtocolo is null)
                        {
                            <MudText Style="font-weight:600" Color=Color.Error>Protocolo Não Gerado</MudText>
                        }
                        else
                        {
                            <MudText Style="font-weight:600">@context.Item.NmrProtocolo</MudText>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.ChaveNf" Title="Chave"></PropertyColumn>
                <PropertyColumn Property="x => x.XMotivo" Title="Status"></PropertyColumn>
                <TemplateColumn T="NFEmitidasDto" Title="Status">
                    <CellTemplate Context="context">
                        <MudText Style="font-weight:600" Color=@(context.Item.CStat == 100 ? Color.Success : Color.Error)>@context.Item.CStat - @context.Item.XMotivo</MudText>
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.CriadoEm" Title="Emissão" Format="dd/MM/yyyy"></PropertyColumn>

                <PropertyColumn Property="x => x.ValorTotalDaNf" Title="Id" Format="C">Valor Da NF</PropertyColumn>
                <PropertyColumn Property="x => x.ValorTotalDosProdutos" Title="Id" Format="C">Valor Dos Prods</PropertyColumn>

                <TemplateColumn T="NFEmitidasDto" Title="Ações">
                    <CellTemplate Context="context">
                        <MudTooltip Text="Clique para mais" Color="Color.Primary">
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                                <MudMenuItem OnClick=@(async () => { await ReimprimirNF(context.Item); }) Icon="@Icons.Material.Filled.Print" Label="Imprimir" />

                                <MudMenuItem OnClick=@(async () => { await DeletaRegistro(context.Item); }) Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error" Label="Cancelar" />

                            </MudMenu>
                        </MudTooltip>
                    </CellTemplate>
                </TemplateColumn>

            </Columns>
            <PagerContent>
                <MudDataGridPager T="NFEmitidasDto" RowsPerPageString="NF's por página" ShowPageNumber="false" PageSizeOptions=@(new int[] { 20, 30, 500, 600, 1000, 3000 }) />
            </PagerContent>
        </MudDataGrid>

        <MudGrid Class="w-100 mt-4" GutterSize="3">
            <!-- Total nfs válidas -->
            <MudItem xs="12" sm="6" md="4">
                <MudCard Class="rounded-2xl shadow-lg" Style="background: linear-gradient(135deg, #1B7FDB, #4AA8F0); color:white;">
                    <MudCardContent Class="flex flex-col items-center justify-center h-36">
                        <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="@Size.Medium" Class="mb-2 text-green-300" />
                        <MudText Typo="Typo.h6" Class="opacity-90">Total em NFs Válidas</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight:600;">@TotalEmNFsValidas.ToString("C")</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Total das cendas -->
            <MudItem xs="12" sm="6" md="4">
                <MudCard Class="rounded-2xl shadow-lg" Style="background: linear-gradient(135deg, #409B44, #66BB6A); color:white;">
                    <MudCardContent Class="flex flex-col items-center justify-center h-36">
                        <MudIcon Icon="@Icons.Material.Filled.PendingActions" Size="@Size.Medium" Class="mb-2 text-red-300" />
                        <MudText Typo="Typo.h6" Class="opacity-90">Total das Vendas</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight:600;">@TotalDasVendas.ToString("C")</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Total de pagamentos em cartões -->
            <MudItem xs="12" sm="12" md="4">
                <MudCard Class="rounded-2xl shadow-lg" Style="background: linear-gradient(135deg, #F88113, #FFB347); color:white;">
                    <MudStack Row=true>
                        <MudCardContent Class="flex flex-col items-center justify-center h-36">
                            <MudIcon Icon="@Icons.Material.Filled.Summarize" Size="@Size.Medium" Class="mb-2 text-yellow-200" />
                            <MudText Typo="Typo.h6" Class="opacity-90">Total de Pagamentos em Cartão</MudText>
                            <MudText Typo="Typo.h4" Style="font-weight:800;">@TotalDePagamentosEmCartoes.ToString("C")</MudText>
                        </MudCardContent>
                    </MudStack>
                </MudCard>
            </MudItem>

            <!-- Total de nfs canceladas -->
            <MudItem xs="12" sm="12" md="4">
                <MudCard Class="rounded-2xl shadow-lg" Style="background: linear-gradient(135deg, #F88113, #FFB347); color:white;">
                    <MudStack Row=true>
                        <MudCardContent Class="flex flex-col items-center justify-center h-36">
                            <MudIcon Icon="@Icons.Material.Filled.Summarize" Size="@Size.Medium" Class="mb-2 text-yellow-200" />
                            <MudText Typo="Typo.h6" Class="opacity-90">Canceladas</MudText>
                            <MudText Typo="Typo.h4" Style="font-weight:800;">@TotalDeNFsCanceladas</MudText>
                        </MudCardContent>
                    </MudStack>
                </MudCard>
            </MudItem>

            <!-- Total de ICMS -->
            <MudItem xs="12" sm="12" md="4">
                <MudCard Class="rounded-2xl shadow-lg" Style="background: linear-gradient(135deg, #F88113, #FFB347); color:white;">
                    <MudStack Row=true>
                        <MudCardContent Class="flex flex-col items-center justify-center h-36">
                            <MudIcon Icon="@Icons.Material.Filled.Summarize" Size="@Size.Medium" Class="mb-2 text-yellow-200" />
                            <MudText Typo="Typo.h6" Class="opacity-90">Total do ICMS</MudText>
                            <MudText Typo="Typo.h4" Style="font-weight:800;">@TotalDeICMS.ToString("C")</MudText>
                        </MudCardContent>
                    </MudStack>
                </MudCard>
            </MudItem>

            <!-- Total de Tributos -->
            <MudItem xs="12" sm="12" md="4">
                <MudCard Class="rounded-2xl shadow-lg" Style="background: linear-gradient(135deg, #F88113, #FFB347); color:white;">
                    <MudStack Row=true>
                        <MudCardContent Class="flex flex-col items-center justify-center h-36">
                            <MudIcon Icon="@Icons.Material.Filled.Summarize" Size="@Size.Medium" Class="mb-2 text-yellow-200" />
                            <MudText Typo="Typo.h6" Class="opacity-90">Total dos Tributos</MudText>
                            <MudText Typo="Typo.h4" Style="font-weight:800;">@TotalDeTributos.ToString("C")</MudText>
                        </MudCardContent>
                    </MudStack>
                </MudCard>
            </MudItem>
        </MudGrid>

    </MudLayout>
</MudPaper>

@code {
    #region Props
    private MudDataGrid<NFEmitidasDto>? dataGridRef = new();

    private bool Carregando = true;

    //lógica do filtros
    private DateTime? FiltroDateTimeInicial = null;
    private DateTime? FiltroDateTimeFinal = null;

    //Props dos totais
    private float TotalEmNFsValidas = 0;
    private float TotalDasVendas = 0;
    private float TotalDePagamentosEmCartoes = 0;
    private float TotalDeNFsCanceladas = 0;
    private float TotalDeICMS = 0;
    private float TotalDeTributos = 0;
    #endregion

    #region Função de load do Grid
    private async Task<GridData<NFEmitidasDto>> LoadServerData(GridState<NFEmitidasDto> itens)
    {
        try
        {
            Carregando = true;

            int page = itens.Page + 1;
            int pageSize = itens.PageSize;


            var result = await NfService.ConsultaNFeEmitidas(FiltroDateTimeInicial, FiltroDateTimeFinal, page, pageSize);

            TotalEmNFsValidas = result.ValorTotalDeNfsEmitidas;

            StateHasChanged();

            return new GridData<NFEmitidasDto>
            {
                Items = result.Data,
                TotalItems = result.Total
            };

        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar NFs: {ex.Message}", Severity.Error);
            return new GridData<NFEmitidasDto>
            {

            };

        }
        finally
        {
            Carregando = false;
        }
    }
    #endregion

    #region Funções de Ações da Página
    private async Task AtualizarPeriodoRapido(int index)
    {

        switch (index)
        {
            case 0: // Mês Passado
                var mesPassado = DateTime.Today.AddMonths(-1);
                FiltroDateTimeInicial = new DateTime(mesPassado.Year, mesPassado.Month, 1);
                FiltroDateTimeFinal = FiltroDateTimeInicial.Value.AddMonths(1).AddDays(-1);
                break;
            case 1: // Semana Passada
                var lastWeekStart = DateTime.Today.StartOfWeek(DayOfWeek.Monday).AddDays(-7);
                FiltroDateTimeInicial = lastWeekStart;
                FiltroDateTimeFinal = lastWeekStart.AddDays(6);
                break;
            case 2: // Hoje
                FiltroDateTimeInicial = DateTime.Today;
                FiltroDateTimeFinal = DateTime.Today;
                break;
            case 3: // Esta Semana
                FiltroDateTimeInicial = DateTime.Today.StartOfWeek(DayOfWeek.Monday);
                FiltroDateTimeFinal = FiltroDateTimeInicial.Value.AddDays(6);
                break;
            case 4: // Semana Que Vem
                FiltroDateTimeInicial = DateTime.Today.StartOfWeek(DayOfWeek.Monday).AddDays(7);
                FiltroDateTimeFinal = FiltroDateTimeInicial.Value.AddDays(6);
                break;
            case 5: // Este Mês
                FiltroDateTimeInicial = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
                FiltroDateTimeFinal = FiltroDateTimeInicial.Value.AddMonths(1).AddDays(-1);
                break;
        }

        StateHasChanged();
        await dataGridRef!.ReloadServerData();
    }

    private async Task AplicarFiltros()
    {
        if (dataGridRef != null)
        {
            await dataGridRef.ReloadServerData();
        }
    }

    private async Task LimparFiltros()
    {
        FiltroDateTimeInicial = null;
        FiltroDateTimeFinal = null;

        if (dataGridRef != null)
        {
            await dataGridRef.ReloadServerData();
        }
    }

    private async Task DeletaRegistro(NFEmitidasDto Registro)
    {
        try
        {
            var parameters = new DialogParameters<ModalDeExcluir>
            {
                    { x => x.ContentText, $"Você tem certeza que deseja excluir o Registtro da NF {Registro.NmrNf}? Atenção, essa ação não pode ser desfeita" },
                    { x => x.ButtonText, "Sim" },
                    { x => x.Color, Color.Error}
            };
            var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Large, CloseOnEscapeKey = true };
            var dialog = await DialogService.ShowAsync<ModalDeExcluir>("Confirmar Exclusão", parameters, options);
            var result = await dialog.Result;

            if (!result!.Canceled && result.Data is bool sucesso && sucesso)
            {
                var optionsInputText = new DialogOptions { CloseButton = true, FullScreen = true, FullWidth = true, MaxWidth = MaxWidth.ExtraExtraLarge, CloseOnEscapeKey = true };
                var dialogInputText = await DialogService.ShowAsync<Components.Modais.ModaisGenericos.InputText>("Motivo", parameters, options);
                var Motivo = await dialogInputText.Result;
                if (!Motivo!.Canceled || string.IsNullOrWhiteSpace(Motivo.Data?.ToString()))
                {
                    Snackbar.Add("Motivo é obrigatório para exclusão da NF.", Severity.Error);
                    return;
                }

                var respostaApi = await NfService.CancelaNFe(Registro.ChaveNf!, Registro.NmrProtocolo!, Registro.NfTipo, Motivo: Motivo.Data.ToString());

                string MensagemDeRetorno = string.Join(", ", respostaApi.Status == "success" ? respostaApi.Data.Messages : respostaApi.Messages);
                Snackbar.Add(MensagemDeRetorno, respostaApi.Status == "success" ? Severity.Success : Severity.Error);


                if (respostaApi.Status == "success")
                    await dataGridRef!.ReloadServerData();
            }
        }
        catch (Exception ex) when (ex is NullReferenceException)
        {
            Snackbar.Add($"Erro ao excluir Registro: Campo nescessario não foi encontrado.", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao excluir Registro: {ex.Message}", Severity.Error);
            //ignorado
        }
    }

    private async Task ReimprimirNF(NFEmitidasDto registro)
    {
        await JS.InvokeVoidAsync("baixarXMLNF", registro.XmlDistribuicao, $"{registro.ChaveNf}-procnfe-copia.xml");
    }
    #endregion

}
