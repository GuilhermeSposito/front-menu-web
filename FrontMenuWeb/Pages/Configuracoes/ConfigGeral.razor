@rendermode RenderMode.InteractiveWebAssembly
@attribute [Authorize]
@page "/config-geral"
@using FrontMenuWeb.Components.Modais.ModaisDeCadastros.Funcionarios
@using FrontMenuWeb.Components.Modais.ModaisDePessoas
@using FrontMenuWeb.Components.Uteis
@using FrontMenuWeb.Models.Merchant
@using FrontMenuWeb.Models.Pessoas
@using FrontMenuWeb.Services
@using Microsoft.AspNetCore.Components
@using System.Globalization;
@using MudBlazor.Extensions
@using MudBlazor.Services
@using MudBlazor.Extensions.Components
@using MudBlazor.Extensions.Services
@using System.Text.Json
@inject MerchantServices MerchantServices

<MudPaper Square="false" Elevation="0" Style="background-color: var(--mud-palette-background); min-height: 100vh; margin-top:50px">
    <MudLayout>
        @if (!Carregando && Merchant is not null)
        {
            @*Informações da loja*@
            <MudPaper Class="rounded-5 p-2" Style="background-color: var(--mud-palette-surface); border: 3px solid var(--mud-palette-primary)" Elevation="2">
                <MudStack AlignItems="AlignItems.Center" Spacing=5 Justify="Justify.Center" Row=true>

                    <MudAvatar Size=Size.Large Color="Color.Primary">S</MudAvatar>
                    <MudPaper Class="rounded-5 p-3 w-75" Style="background-color: var(--mud-palette-background);" Elevation="2">
                        <MudText Align="Align.Center" Typo="Typo.h4">Informações da Empresa</MudText>
                    </MudPaper>
                    <MudButton OnClick=@(() => { EditandoInfosLojaBloq = !EditandoInfosLojaBloq; }) Color=Color.Primary Size=Size.Large EndIcon="@Icons.Material.Filled.Edit"></MudButton>
                </MudStack>

                <MudGrid Class="mt-2 p-2 mb-1">
                    <MudItem xs="12" md="4" lg="4">
                        <MudTextField @onfocusout=SalvarInfosLojaAsync Disabled=EditandoInfosLojaBloq @bind-Value=@Merchant.NomeFantasia Immediate=true Label="Nome da Loja" AdornmentColor=Color.Primary Variant="Variant.Outlined" FullWidth="true" />
                    </MudItem>
                    <MudItem xs="12" md="4" lg="4">
                        <MudTextField @onfocusout=SalvarInfosLojaAsync Disabled=EditandoInfosLojaBloq @bind-Value=@Merchant.RazaoSocial Immediate=true Label="Razão Social" Variant="Variant.Outlined" FullWidth="true" />
                    </MudItem>
                    <MudItem xs="12" md="4" lg="4">
                        <MudTextField @onfocusout=SalvarInfosLojaAsync Disabled=EditandoInfosLojaBloq @bind-Value=@Merchant.Email Immediate=true Label="Email" Variant="Variant.Outlined" FullWidth="true" />
                    </MudItem>
                    <MudItem xs="12" md="4" lg="4">
                        <MudTextField Disabled=true @bind-Value=@Merchant.UltimoNmrSerieNFCe Immediate=true Label="U/NFCE" Variant="Variant.Outlined" FullWidth="true" />
                    </MudItem>
                    <MudItem xs="12" md="4" lg="4">
                        <MudTextField @onfocusout=SalvarInfosLojaAsync Disabled=EditandoInfosLojaBloq @bind-Value=@Merchant.CrtMerchant Label="CTR" Variant="Variant.Outlined" FullWidth="true" />
                    </MudItem>
                    <MudItem xs="12" md="4" lg="4">
                        <MudTextField Disabled=true @bind-Value=@Merchant.UltimoNmrSerieNFe Label="U/NFE" Variant="Variant.Outlined" FullWidth="true" />
                    </MudItem>
                </MudGrid>

            </MudPaper>


            @*Parametros Gerais*@
            <MudPaper Class="rounded-5 p-2 mt-4" Style="background-color: var(--mud-palette-surface); border: 3px solid var(--mud-palette-primary)" Elevation="2">
                <MudStack AlignItems="AlignItems.Center" Spacing=5 Justify="Justify.Center" Row=true>
                    <MudPaper Class="rounded-5 p-3 w-75" Style="background-color: var(--mud-palette-background);" Elevation="2">
                        <MudText Align="Align.Center" Typo="Typo.h4">Parametros Gerais</MudText>
                    </MudPaper>
                </MudStack>

                @*Impressões*@
                <MudStack Class="m-5">
                    <MudDivider DividerType="DividerType.FullWidth" Light=true />
                    <MudStack Class="w-100" Row=true AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.h5">Impressões</MudText>
                        <MudLink Href="https://syslogica.com.br/SophosSync/setup.exe">Clique aqui para baixar o modulo de impressão</MudLink>
                    </MudStack>
                    <MudDivider DividerType="DividerType.FullWidth" Light=true />

                    <MudStack Class="rounded-2 p-1" style="background-color: var(--mud-palette-background);" AlignItems="AlignItems.Center" Justify="Justify.Center">
                        <MudGrid Class="w-100">
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox @bind-Value=@Merchant.ImprimeComandasDelivery T=bool Color="Color.Primary">Imprime Comanda no Delivery</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox @bind-Value=@Merchant.ImprimeComandasBalcao T=bool Color="Color.Primary">Imprime Comanda no Balcão</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox @bind-Value=@Merchant.ImprimeComandasMesas T=bool Color="Color.Primary">Imprime Comanda das Mesas</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox @bind-Value=@Merchant.ImprimeComandasSeparadaPorProdutos T=bool Color="Color.Primary">Imprime Comanda separada por produtos</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox @bind-Value=@Merchant.DestacaObsNaImpressao T=bool Color="Color.Primary">Destaca Obs na Comanda</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox @bind-Value=@Merchant.ImprimeNomeNaComanda T=bool Color="Color.Primary">Imprime Nome na Comanda</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox @bind-Value=@Merchant.ImprimeEnderecoNaComanda T=bool Color="Color.Primary">Imprime Endereço na Comanda</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox @bind-Value=@Merchant.ImprimeHorarioNaComanda T=bool Color="Color.Primary">Imprime Horario na comanda</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudStack AlignItems=AlignItems.Center Row=true>
                                    <MudNumericField @bind-Value=@Merchant.QtdViasDaComanda Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 Class="w-25" T="int" />
                                    <MudText Class="w-75">Nmr de Vias da Comanda</MudText>
                                </MudStack>
                            </MudItem>
                        </MudGrid>

                    </MudStack>

                    <MudDivider DividerType="DividerType.FullWidth" Light=true />
                    <MudStack Class="w-100" Row=true AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.h5">Fiscal</MudText>
                        <MudButton OnClick=@(() => { EditandoInfosFiscaisBloq = !EditandoInfosFiscaisBloq; }) Color=Color.Primary Size=Size.Large EndIcon="@Icons.Material.Filled.Edit"></MudButton>
                    </MudStack>
                    <MudDivider DividerType="DividerType.FullWidth" Light=true />

                    <MudGrid Class=" p-2 mb-1">
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.PCredSimplesNacional Immediate=true Label="Posicao De Credito" AdornmentColor=Color.Primary Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.AliquotaIrpj Immediate=true Label="Aliquota IRPJ" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.AliquotaIcms Immediate=true Label="Alquota ICMS" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.AliquotaPis Immediate=true Label="Aliquota PIS" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.AliquotaCofins Immediate=true Label="Aliquota COFINS" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.AliquotaIssqn Immediate=true Label="Aliquota ISSQN" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.AliquotaCsll Immediate=true Label="Aliquota CSLL" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudTextField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="string" @bind-Value=@Merchant.CfopDeServico Immediate=true Label="CFOP De Serviço" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudTextField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="string" @bind-Value=@Merchant.NcmDeServico Immediate=true Label="NCM De Serviço" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" sm="12" md="12">
                            <MudStack AlignItems=AlignItems.Center Row=true>
                                <MudTextField Disabled=EditandoInfosFiscaisBloq @bind-Value="CertificadoCarregado" Label="Certificado Digital" T="string" InputType="InputType.Password" Variant="Variant.Outlined" FullWidth="true" Immediate=true />
                                @if (!CarregouNovoCertificado)
                                {
                                    <MudFileUpload Disabled=EditandoInfosFiscaisBloq T="IBrowserFile" FilesChanged="UploadCertificado">
                                        <ActivatorContent>
                                            <MudButton Variant="Variant.Filled"
                                                       Color="Color.Primary"
                                                       StartIcon="@Icons.Material.Filled.CloudUpload">
                                                Selecionar Certificado
                                            </MudButton>
                                        </ActivatorContent>
                                    </MudFileUpload>
                                }
                                else
                                {
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.Save"
                                               OnClick="SalvarInfosLojaAsync"
                                               Disabled=EditandoInfosFiscaisBloq>
                                        Salvar
                                    </MudButton>
                                }
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" sm="12" md="12">
                            <MudStack AlignItems=AlignItems.Center Row=true>
                                <MudTextField Disabled=EditandoInfosFiscaisBloq @bind-Value="Merchant.SenhaCertificado" Label="Senha Certificado" T="string" InputType="InputType.Password" Variant="Variant.Outlined" FullWidth="true" Immediate=true />
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Save"
                                           OnClick="SalvarInfosLojaAsync"
                                           Disabled=EditandoInfosFiscaisBloq>
                                    Salvar
                                </MudButton>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" sm="12" md="12">
                            <MudCheckBox ValueChanged="OnEmitindoNfeProdChanged" Value=Merchant.EmitindoNfeProd Disabled=EditandoInfosFiscaisBloq T=bool Color="Color.Primary">Emitindo em Produção</MudCheckBox>
                        </MudItem>
                    </MudGrid>


                    <MudDivider DividerType="DividerType.FullWidth" Light=true />
                    <MudText Typo="Typo.h5">TEMPOS</MudText>
                    <MudDivider DividerType="DividerType.FullWidth" Light=true />

                    <MudGrid Class=" p-2 mb-1">
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField @onfocusout=SalvarInfosLojaAsync @bind-value=@Merchant.TempoDeEntregaEMmin T="int" Immediate=true Label="Tempo em Min (ENTREGA)" AdornmentColor=Color.Primary Variant="Variant.Outlined" FullWidth="true" AdornmentIcon="@Icons.Material.Filled.LockClock" Adornment="Adornment.Start" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField @onfocusout=SalvarInfosLojaAsync @bind-value=@Merchant.TempoDeRetiradaEMmin T="int" Immediate=true Label="Tempo em Min (RETIRADA)" Variant="Variant.Outlined" FullWidth="true" AdornmentIcon="@Icons.Material.Filled.LockClock" Adornment="Adornment.Start" AdornmentColor=Color.Primary />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField @onfocusout=SalvarInfosLojaAsync @bind-value=@Merchant.TempoDePreparacaoEmMin T="int" Immediate=true Label="Tempo em Min (PREPARO)" Variant="Variant.Outlined" FullWidth="true" AdornmentIcon="@Icons.Material.Filled.LockClock" Adornment="Adornment.Start" AdornmentColor=Color.Primary />
                        </MudItem>
                    </MudGrid>

                    <MudDivider DividerType="DividerType.FullWidth" Light=true />
                    <MudStack Class="w-100" Row=true AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.h5">Entrega</MudText>
                        <MudButton OnClick=@(() => { EditandoInfosEntregaBloq = !EditandoInfosEntregaBloq; }) Color=Color.Primary Size=Size.Large EndIcon="@Icons.Material.Filled.Edit"></MudButton>
                    </MudStack>
                    <MudDivider DividerType="DividerType.FullWidth" Light=true />
                    <MudGrid Class=" p-2 mb-1">
                        <MudItem xs="12" md="12" lg="12">
                            <MudNumericField Disabled=EditandoInfosEntregaBloq Value="1" T="float" Immediate=true Label="Valor por km" Variant="Variant.Outlined" FullWidth="true" AdornmentText="R$" Adornment="Adornment.Start" AdornmentColor=Color.Primary />
                        </MudItem>
                    </MudGrid>
                </MudStack>
            </MudPaper>

            @*Enderecos das Empresa*@
            <MudPaper Class="rounded-5 p-2 mt-4" Style="background-color: var(--mud-palette-surface); border: 3px solid var(--mud-palette-primary)" Elevation="2">
                <MudStack AlignItems="AlignItems.Center" Spacing=5 Justify="Justify.Center" Row=true>
                    <MudPaper Class="rounded-5 p-3 w-75" Style="background-color: var(--mud-palette-background);" Elevation="2">
                        <MudText Align="Align.Center" Typo="Typo.h4">Enderecos da Empresa</MudText>
                    </MudPaper>
                    <MudButton Color=Color.Primary Size=Size.Large EndIcon="@Icons.Material.Filled.Edit"></MudButton>
                </MudStack>
            </MudPaper>

            @*Documentos das Empresa*@
            <MudPaper Class="rounded-5 p-2 mt-4" Style="background-color: var(--mud-palette-surface); border: 3px solid var(--mud-palette-primary)" Elevation="2">
                <MudStack AlignItems="AlignItems.Center" Spacing=5 Justify="Justify.Center" Row=true>
                    <MudPaper Class="rounded-5 p-3 w-75" Style="background-color: var(--mud-palette-background);" Elevation="2">
                        <MudText Align="Align.Center" Typo="Typo.h4">Documentos da Empresa</MudText>
                    </MudPaper>
                    <MudButton Color=Color.Primary Size=Size.Large EndIcon="@Icons.Material.Filled.Edit"></MudButton>
                </MudStack>
            </MudPaper>
        }
        else
        {

        }
    </MudLayout>
</MudPaper>

@code {
    #region Propriedades
    //props de loja
    private ClsMerchant? Merchant = new();
    private ClsMerchant? MerchantParaComparacao = new();
    private string CertificadoCarregado = string.Empty;

    //props auxiliares
    private bool Carregando = false;
    private bool EditandoInfosLojaBloq = true;
    private bool EditandoInfosFiscaisBloq = true;
    private bool EditandoInfosEntregaBloq = true;
    private bool CarregouNovoCertificado = false;
    #endregion


    #region Funcao De Inicialização da página
    protected override async Task OnInitializedAsync()
    {
        try
        {
            Merchant = await MerchantServices.GetMerchantAsync();
            MerchantParaComparacao = Merchant;

            if (Merchant is not null && !string.IsNullOrEmpty(Merchant.CertificadoBase64))
            {
                CertificadoCarregado = Merchant.CertificadoBase64;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar dados da loja: {ex.Message}", Severity.Error);
        }
        finally
        {
            Carregando = false;
        }
    }
    #endregion

    #region Funcoes Auxiliares
    private async Task SalvarInfosLojaAsync()
    {
        try
        {
            if (Merchant is not null && MerchantParaComparacao is not null)
            {
                var resultado = await MerchantServices.UpdateMerchantAsync(Merchant);
                var sucesso = resultado.Status == "success" ? true : false;
                string mensagem = sucesso ? string.Join(",", resultado.Data.Messages) : string.Join(",", resultado.Messages);
                Snackbar.Add(mensagem, sucesso ? Severity.Success : Severity.Error);

                EditandoInfosLojaBloq = true;
                EditandoInfosFiscaisBloq = true;
                CarregouNovoCertificado = false;
                MerchantParaComparacao = Merchant;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar dados da loja: {ex.Message}", Severity.Error);
        }
    }

    private async void UploadCertificado(IBrowserFile file)
    {
        using var stream = file.OpenReadStream();
        using var ms = new MemoryStream();

        await stream.CopyToAsync(ms);

        byte[] certificadoBytes = ms.ToArray();
        string base64 = Convert.ToBase64String(certificadoBytes);

        CertificadoCarregado = base64;
        CarregouNovoCertificado = true;
        StateHasChanged();
    }

    #region Funções de select
    private async Task OnEmitindoNfeProdChanged(bool valor)
    {
        if (Merchant is null)
            return;

        Merchant.EmitindoNfeProd = valor;
        await SalvarInfosLojaAsync();
    }
    #endregion



    #endregion
}
