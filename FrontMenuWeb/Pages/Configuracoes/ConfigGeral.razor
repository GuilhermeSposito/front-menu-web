@rendermode RenderMode.InteractiveWebAssembly
@attribute [Authorize]
@page "/config-geral"
@using FrontMenuWeb.Components.Modais.ModaisDeCadastros.Funcionarios
@using FrontMenuWeb.Components.Modais.ModaisDePessoas
@using FrontMenuWeb.Components.Uteis
@using FrontMenuWeb.Models.Merchant
@using FrontMenuWeb.Models.Pessoas
@using FrontMenuWeb.Services
@using Microsoft.AspNetCore.Components
@using System.Globalization;
@using MudBlazor.Extensions
@using MudBlazor.Services
@using MudBlazor.Extensions.Components
@using MudBlazor.Extensions.Services
@using System.Text.Json
@inject MerchantServices MerchantServices

<MudPaper Square="false" Elevation="0" Style="background-color: var(--mud-palette-background); min-height: 100vh; margin-top:50px">
    <MudLayout>
        @if (!Carregando && Merchant is not null)
        {
            @*Informações da loja*@
            <MudPaper Class="rounded-5 p-2" Style="background-color: var(--mud-palette-surface); border: 3px solid var(--mud-palette-primary)" Elevation="2">
                <MudStack AlignItems="AlignItems.Center" Spacing=5 Justify="Justify.Center" Row=true>

                    <MudAvatar Size=Size.Large Color="Color.Primary">S</MudAvatar>
                    <MudPaper Class="rounded-5 p-3 w-75" Style="background-color: var(--mud-palette-background);" Elevation="2">
                        <MudText Align="Align.Center" Typo="Typo.h4">Informações da Empresa</MudText>
                    </MudPaper>
                    <MudButton OnClick=@(() => { EditandoInfosLojaBloq = !EditandoInfosLojaBloq; }) Color=Color.Primary Size=Size.Large EndIcon="@Icons.Material.Filled.Edit"></MudButton>
                </MudStack>

                <MudGrid Class="mt-2 p-2 mb-1">
                    <MudItem xs="12" md="4" lg="4">
                        <MudTextField @onfocusout=SalvarInfosLojaAsync Disabled=EditandoInfosLojaBloq @bind-Value=@Merchant.NomeFantasia Immediate=true Label="Nome da Loja" AdornmentColor=Color.Primary Variant="Variant.Outlined" FullWidth="true" />
                    </MudItem>
                    <MudItem xs="12" md="4" lg="4">
                        <MudTextField @onfocusout=SalvarInfosLojaAsync Disabled=EditandoInfosLojaBloq @bind-Value=@Merchant.RazaoSocial Immediate=true Label="Razão Social" Variant="Variant.Outlined" FullWidth="true" />
                    </MudItem>
                    <MudItem xs="12" md="4" lg="4">
                        <MudTextField @onfocusout=SalvarInfosLojaAsync Disabled=EditandoInfosLojaBloq @bind-Value=@Merchant.Email Immediate=true Label="Email" Variant="Variant.Outlined" FullWidth="true" />
                    </MudItem>
                    <MudItem xs="12" md="4" lg="4">
                        <MudTextField Disabled=true @bind-Value=@Merchant.UltimoNmrSerieNFCe Immediate=true Label="U/NFCE" Variant="Variant.Outlined" FullWidth="true" />
                    </MudItem>
                    <MudItem xs="12" md="4" lg="4">
                        <MudTextField @onfocusout=SalvarInfosLojaAsync Disabled=EditandoInfosLojaBloq @bind-Value=@Merchant.CrtMerchant Label="CTR" Variant="Variant.Outlined" FullWidth="true" />
                    </MudItem>
                    <MudItem xs="12" md="4" lg="4">
                        <MudTextField Disabled=true @bind-Value=@Merchant.UltimoNmrSerieNFe Label="U/NFE" Variant="Variant.Outlined" FullWidth="true" />
                    </MudItem>
                </MudGrid>

            </MudPaper>


            @*Parametros Gerais*@
            <MudPaper Class="rounded-5 p-2 mt-4" Style="background-color: var(--mud-palette-surface); border: 3px solid var(--mud-palette-primary)" Elevation="2">
                <MudStack AlignItems="AlignItems.Center" Spacing=5 Justify="Justify.Center" Row=true>
                    <MudPaper Class="rounded-5 p-3 w-75" Style="background-color: var(--mud-palette-background);" Elevation="2">
                        <MudText Align="Align.Center" Typo="Typo.h4">Parametros Gerais</MudText>
                    </MudPaper>
                </MudStack>

                @*Impressões*@
                <MudStack Class="m-5">
                    <MudDivider DividerType="DividerType.FullWidth" Light=true />
                    <MudStack Class="w-100" Row=true AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.h5">Impressões / Fechamento</MudText>
                        <MudLink Href="https://syslogica.com.br/SophosSync/setup.exe">Clique aqui para baixar o modulo de impressão</MudLink>
                    </MudStack>
                    <MudDivider DividerType="DividerType.FullWidth" Light=true />

                    <MudStack Class="rounded-2 p-1" style="background-color: var(--mud-palette-background);" AlignItems="AlignItems.Center" Justify="Justify.Center">
                        <MudGrid Class="w-100">
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox Value=@Merchant.ReplicaFechamentoParaOFinanceiro ValueChanged=@(v=> OnMudCheckBoxChangedGenerico(v, x => Merchant.ReplicaFechamentoParaOFinanceiro = x)) T=bool Color="Color.Primary">Replica Fechamento</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox Value=@Merchant.ImprimeComandasDelivery ValueChanged=@(v=> OnMudCheckBoxChangedGenerico(v, x => Merchant.ImprimeComandasDelivery = x)) T=bool Color="Color.Primary">Imprime Comanda no Delivery</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox Value=@Merchant.ImprimeComandasBalcao  ValueChanged=@(v=> OnMudCheckBoxChangedGenerico(v, x => Merchant.ImprimeComandasBalcao = x)) T=bool Color="Color.Primary">Imprime Comanda no Balcão</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox Value=@Merchant.ImprimeComandasMesas ValueChanged=@(v=> OnMudCheckBoxChangedGenerico(v, x => Merchant.ImprimeComandasMesas = x)) T=bool Color="Color.Primary">Imprime Comanda das Mesas</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox Value=@Merchant.ImprimeComandasSeparadaPorProdutos ValueChanged=@(v=> OnMudCheckBoxChangedGenerico(v, x => Merchant.ImprimeComandasSeparadaPorProdutos = x)) T=bool Color="Color.Primary">Imprime Comanda separada por produtos</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox Value=@Merchant.DestacaObsNaImpressao ValueChanged=@(v=> OnMudCheckBoxChangedGenerico(v, x => Merchant.DestacaObsNaImpressao = x)) T=bool Color="Color.Primary">Destaca Obs na Comanda</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox Value=@Merchant.ImprimeNomeNaComanda ValueChanged=@(v=> OnMudCheckBoxChangedGenerico(v, x => Merchant.ImprimeNomeNaComanda = x)) T=bool Color="Color.Primary">Imprime Nome na Comanda</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox Value=@Merchant.ImprimeEnderecoNaComanda ValueChanged=@(v=> OnMudCheckBoxChangedGenerico(v, x => Merchant.ImprimeEnderecoNaComanda = x)) T=bool Color="Color.Primary">Imprime Endereço na Comanda</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudCheckBox Value=@Merchant.ImprimeHorarioNaComanda ValueChanged=@(v=> OnMudCheckBoxChangedGenerico(v, x => Merchant.ImprimeHorarioNaComanda = x)) T=bool Color="Color.Primary">Imprime Horario na comanda</MudCheckBox>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField Variant="Variant.Outlined" Label="Nmr de Vias da Comanda" @bind-Value=@Merchant.QtdViasDaComanda HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 T="int" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField Variant="Variant.Outlined" @bind-Value=@Merchant.EspacamentoNaImpressao Label="Espaçamento" HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 T="int" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField Label="Fonte Detalhes" Variant="Variant.Outlined" @bind-Value=@Merchant.TamFonteDetalhesPedido HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 T="int" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                    <MudNumericField Label="Fonte Item" Variant="Variant.Outlined" @bind-Value=@Merchant.TamFonteDescricaoItem HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0  T="int" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField Label="Fonte Item (Comanda)" Variant="Variant.Outlined" @bind-Value=@Merchant.TamFonteDescricaoItemNaComanda HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 T="int" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField Label="Fonte Complemento" Variant="Variant.Outlined" @bind-Value=@Merchant.TamFonteDescricaoComplemento HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 T="int" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField Label="Fonte Complemento (Comanda)" Variant="Variant.Outlined" @bind-Value=@Merchant.TamFonteDescricaoComplementoNaComanda HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 T="int" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField Label="Fonte Valor Item" Variant="Variant.Outlined" @bind-Value=@Merchant.TamFonteValorItem HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 T="int" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField Label="Fonte Tempos e Conta" Variant="Variant.Outlined" @bind-Value=@Merchant.TamFonteTempoEntregaEConta HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 T="int" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField Label="Fonte Legenda Itens" Variant="Variant.Outlined" @bind-Value=@Merchant.TamFonteLegendaDosItens HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 T="int" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField Label="Fonte Totais" Variant="Variant.Outlined" @bind-Value=@Merchant.TamFonteTotais HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 T="int" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField Label="Fonte Infos De Pag" Variant="Variant.Outlined" @bind-Value=@Merchant.TamFonteInfosPag HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 T="int" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudNumericField Label="Fonte Nome (Comanda)" Variant="Variant.Outlined" @bind-Value=@Merchant.TamFonteNomeClienteComanda HideSpinButtons="true" Immediate=true @onfocusout=SalvarInfosLojaAsync Min=0 T="int" />
                            </MudItem>

                            <MudItem xs="12" sm="6" md="3">
                                <MudButton OnClick=@(async () => { Merchant.TamFonteNomeClienteComanda = 12; Merchant.EspacamentoNaImpressao = 19; Merchant.TamFonteDescricaoComplementoNaComanda = 11; Merchant.TamFonteDescricaoItemNaComanda = 11; Merchant.TamFonteDetalhesPedido = 9; Merchant.TamFonteDescricaoItem = 11; Merchant.TamFonteDescricaoComplemento = 9; Merchant.TamFonteValorItem = 8; Merchant.TamFonteTempoEntregaEConta = 12; Merchant.TamFonteLegendaDosItens = 8; Merchant.TamFonteTotais = 12; Merchant.TamFonteInfosPag = 10; await SalvarInfosLojaAsync(); }) Color="Color.Primary" Variant="Variant.Filled">Resetar Fontes</MudButton>
                            </MudItem>
                        </MudGrid>

                    </MudStack>

                    <MudDivider DividerType="DividerType.FullWidth" Light=true />
                    <MudStack Class="w-100" Row=true AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.h5">Fiscal</MudText>
                        <MudButton OnClick=@(() => { EditandoInfosFiscaisBloq = !EditandoInfosFiscaisBloq; }) Color=Color.Primary Size=Size.Large EndIcon="@Icons.Material.Filled.Edit"></MudButton>
                    </MudStack>
                    <MudDivider DividerType="DividerType.FullWidth" Light=true />

                    <MudGrid Class=" p-2 mb-1">
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.PCredSimplesNacional Immediate=true Label="Posicao De Credito" AdornmentColor=Color.Primary Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.AliquotaIrpj Immediate=true Label="Aliquota IRPJ" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.AliquotaIcms Immediate=true Label="Alquota ICMS" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.AliquotaPis Immediate=true Label="Aliquota PIS" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.AliquotaCofins Immediate=true Label="Aliquota COFINS" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.AliquotaIssqn Immediate=true Label="Aliquota ISSQN" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="decimal" @bind-Value=@Merchant.AliquotaCsll Immediate=true Label="Aliquota CSLL" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudTextField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="string" @bind-Value=@Merchant.CfopDeServico Immediate=true Label="CFOP De Serviço" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudTextField Disabled=EditandoInfosFiscaisBloq @onfocusout=SalvarInfosLojaAsync T="string" @bind-Value=@Merchant.NcmDeServico Immediate=true Label="NCM De Serviço" Variant="Variant.Outlined" FullWidth="true" />
                        </MudItem>
                        <MudItem xs="12" sm="12" md="12">
                            <MudStack AlignItems=AlignItems.Center Row=true>
                                <MudTextField Disabled=EditandoInfosFiscaisBloq @bind-Value="CertificadoCarregado" Label="Certificado Digital" T="string" InputType="InputType.Password" Variant="Variant.Outlined" FullWidth="true" Immediate=true />
                                @if (!CarregouNovoCertificado)
                                {
                                    <MudFileUpload Disabled=EditandoInfosFiscaisBloq T="IBrowserFile" FilesChanged="UploadCertificado">
                                        <ActivatorContent>
                                            <MudButton Variant="Variant.Filled"
                                                       Color="Color.Primary"
                                                       StartIcon="@Icons.Material.Filled.CloudUpload">
                                                Selecionar Certificado
                                            </MudButton>
                                        </ActivatorContent>
                                    </MudFileUpload>
                                }
                                else
                                {
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.Save"
                                               OnClick="SalvarInfosLojaAsync"
                                               Disabled=EditandoInfosFiscaisBloq>
                                        Salvar
                                    </MudButton>
                                }
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" sm="12" md="12">
                            <MudStack AlignItems=AlignItems.Center Row=true>
                                <MudTextField Disabled=EditandoInfosFiscaisBloq @bind-Value="Merchant.SenhaCertificado" Label="Senha Certificado" T="string" InputType="InputType.Password" Variant="Variant.Outlined" FullWidth="true" Immediate=true />
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Save"
                                           OnClick="SalvarInfosLojaAsync"
                                           Disabled=EditandoInfosFiscaisBloq>
                                    Salvar
                                </MudButton>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" sm="12" md="12">
                            <MudCheckBox ValueChanged="OnEmitindoNfeProdChanged" Value=Merchant.EmitindoNfeProd Disabled=EditandoInfosFiscaisBloq T=bool Color="Color.Primary">Emitindo em Produção</MudCheckBox>
                        </MudItem>
                    </MudGrid>


                    <MudDivider DividerType="DividerType.FullWidth" Light=true />
                    <MudText Typo="Typo.h5">TEMPOS</MudText>
                    <MudDivider DividerType="DividerType.FullWidth" Light=true />

                    <MudGrid Class=" p-2 mb-1">
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField @onfocusout=SalvarInfosLojaAsync @bind-value=@Merchant.TempoDeEntregaEMmin T="int" Immediate=true Label="Tempo em Min (ENTREGA)" AdornmentColor=Color.Primary Variant="Variant.Outlined" FullWidth="true" AdornmentIcon="@Icons.Material.Filled.LockClock" Adornment="Adornment.Start" />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField @onfocusout=SalvarInfosLojaAsync @bind-value=@Merchant.TempoDeRetiradaEMmin T="int" Immediate=true Label="Tempo em Min (RETIRADA)" Variant="Variant.Outlined" FullWidth="true" AdornmentIcon="@Icons.Material.Filled.LockClock" Adornment="Adornment.Start" AdornmentColor=Color.Primary />
                        </MudItem>
                        <MudItem xs="12" md="4" lg="4">
                            <MudNumericField @onfocusout=SalvarInfosLojaAsync @bind-value=@Merchant.TempoDePreparacaoEmMin T="int" Immediate=true Label="Tempo em Min (PREPARO)" Variant="Variant.Outlined" FullWidth="true" AdornmentIcon="@Icons.Material.Filled.LockClock" Adornment="Adornment.Start" AdornmentColor=Color.Primary />
                        </MudItem>
                    </MudGrid>

                    <MudDivider DividerType="DividerType.FullWidth" Light=true />
                    <MudStack Class="w-100" Row=true AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.h5">Entrega</MudText>
                        <MudButton OnClick=@(() => { EditandoInfosEntregaBloq = !EditandoInfosEntregaBloq; }) Color=Color.Primary Size=Size.Large EndIcon="@Icons.Material.Filled.Edit"></MudButton>
                    </MudStack>
                    <MudDivider DividerType="DividerType.FullWidth" Light=true />
                    <MudGrid Class=" p-2 mb-1">
                        <MudItem xs="12" md="12" lg="12">
                            <MudNumericField Disabled=EditandoInfosEntregaBloq @bind-Value=Merchant.ValorPorKm @onfocusout=SalvarInfosLojaAsync T="float" Immediate=true Label="Valor por km" Variant="Variant.Outlined" FullWidth="true" AdornmentText="R$" Adornment="Adornment.Start" AdornmentColor=Color.Primary />
                        </MudItem>
                        <MudItem xs="12" md="12" lg="12">
                            <MudNumericField Disabled=EditandoInfosEntregaBloq @bind-Value=Merchant.KmMinimo @onfocusout=SalvarInfosLojaAsync T="float" Immediate=true Label="Km Minimo" Variant="Variant.Outlined" FullWidth="true" Adornment="Adornment.Start" AdornmentColor=Color.Primary />
                        </MudItem>
                        <MudItem xs="12" md="12" lg="12">
                            <MudNumericField Disabled=EditandoInfosEntregaBloq @bind-Value=Merchant.ValorKmMinimo @onfocusout=SalvarInfosLojaAsync T="float" Immediate=true Label="Valor Km Minimo" Variant="Variant.Outlined" FullWidth="true" AdornmentText="R$" Adornment="Adornment.Start" AdornmentColor=Color.Primary />
                        </MudItem>
                        <MudItem xs="12" md="12" lg="12">
                            <MudExTextField Disabled=EditandoInfosEntregaBloq @bind-Value=Merchant.TokenApiEntrega @onfocusout=SalvarInfosLojaAsync T="string" Immediate=true Label="Token Para Entregas Automaticas" Variant="Variant.Outlined" FullWidth="true"  Adornment="Adornment.Start" AdornmentColor=Color.Primary />
                        </MudItem>
                        <MudItem xs="12" md="12" lg="12">
                            <MudCheckBox ValueChanged="@(v => OnMudCheckBoxChangedGenerico(v, x => Merchant.EnviaPedidoAutTaxyMachine = x))" Value=Merchant.EnviaPedidoAutTaxyMachine Disabled=EditandoInfosEntregaBloq T=bool Color="Color.Primary">Envia Pedido Automatico</MudCheckBox>
                        </MudItem>
                        <MudItem xs="12" md="12" lg="12">
                            <MudCheckBox ValueChanged="@(v => OnMudCheckBoxChangedGenerico(v, x => Merchant.UltilizaEntregaPorKm = x))" Value=Merchant.UltilizaEntregaPorKm Disabled=EditandoInfosEntregaBloq T=bool Color="Color.Primary">Soma Entregas Por Km</MudCheckBox>
                        </MudItem>
                    </MudGrid>
                </MudStack>
            </MudPaper>

            @*Enderecos das Empresa*@
            <MudPaper Class="rounded-5 p-2 mt-4" Style="background-color: var(--mud-palette-surface); border: 3px solid var(--mud-palette-primary)" Elevation="2">
                <MudStack AlignItems="AlignItems.Center" Spacing=5 Justify="Justify.Center" Row=true>
                    <MudPaper Class="rounded-5 p-3 w-75" Style="background-color: var(--mud-palette-background);" Elevation="2">
                        <MudText Align="Align.Center" Typo="Typo.h4">Endereços da Empresa</MudText>
                    </MudPaper>
                    <MudButton OnClick=@(() => { EditandoEnderecosBloq = !EditandoEnderecosBloq; }) Color=Color.Primary Size=Size.Large EndIcon="@Icons.Material.Filled.Edit"></MudButton>
                    <MudButton OnClick=@(() => { AdicionandoNovoEndereco = !AdicionandoNovoEndereco; if (AdicionandoNovoEndereco) { NovoEndereco = new EnderecoMerchant() { AdicionandoEsseEndereco = true }; } else { NovoEndereco = null; } }) Color=Color.Primary Size=Size.Large EndIcon="@Icons.Material.Filled.Add"></MudButton>
                </MudStack>
                @{
                    foreach (var end in Merchant.EnderecosMerchant)
                    {
                        <MudStack>
                            <MudText Class="m-2" Typo="Typo.subtitle1">Endereço:</MudText>
                            <MudGrid Class="p-2 mb-1">
                                <MudItem xs="8" md="8" lg="8" xxl="8">
                                    <MudTextField Disabled=EditandoEnderecosBloq @onfocusout=@(async () => { await AtualizarEnderecoEnderecoAsync(end); }) T="string" @bind-Value=@end.Rua Immediate=true Label="Rua" Variant="Variant.Outlined" FullWidth="true" />
                                </MudItem>
                                <MudItem xs="4" md="4" lg="4" xxl="4">
                                    <MudTextField Disabled=EditandoEnderecosBloq @onfocusout=@(async () => { await AtualizarEnderecoEnderecoAsync(end); }) T="string" @bind-Value=@end.Numero Immediate=true Label="Numero" Variant="Variant.Outlined" FullWidth="true" />
                                </MudItem>
                                <MudItem xs="4" md="4" lg="4" xxl="4">
                                    <MudTextField Disabled=EditandoEnderecosBloq @onfocusout=@(async () => { await AtualizarEnderecoEnderecoAsync(end); }) T="string" @bind-Value=@end.Bairro Immediate=true Label="Bairro" Variant="Variant.Outlined" FullWidth="true" />
                                </MudItem>
                                <MudItem xs="4" md="4" lg="4" xxl="4">
                                    <MudSelect T="string"
                                               Label="UF"
                                               Variant="Variant.Outlined"
                                               FullWidth="true"
                                               Disabled="EditandoEnderecosBloq"
                                               @bind-Value="end.Uf"
                                               @onfocusout=@(async () => { await AtualizarEnderecoEnderecoAsync(end); })>
                                        @foreach (var uf in Ufs)
                                        {
                                            <MudSelectItem Value="@uf">@uf</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="4" md="4" lg="4" xxl="4">
                                    <MudTextField @onfocusout=@(async () => { await AtualizarEnderecoEnderecoAsync(end); }) Disabled=EditandoEnderecosBloq T="string" @bind-Value=@end.Cep Immediate=true Label="CEP" Variant="Variant.Outlined" FullWidth="true" />
                                </MudItem>
                                @if (end.Cidade is not null)
                                {
                                    <MudItem xs="8" md="8" lg="8" xxl="8">
                                        <MudTextField Disabled=true T="string" @bind-Value=@end.Cidade.Descricao Immediate=true Label="Cidade" Variant="Variant.Outlined" FullWidth="true" />
                                    </MudItem>
                                    <MudItem xs="4" md="4" lg="4" xxl="4">
                                        <MudTextField Disabled=true T="int" @bind-Value=@end.Cidade.NumCidade Immediate=true Label="Cidade" Variant="Variant.Outlined" FullWidth="true" />
                                    </MudItem>
                                }
                            </MudGrid>
                            <MudStack Class="p-3" AlignItems="AlignItems.End" Justify="Justify.FlexEnd">
                                <MudButton Disabled=EditandoEnderecosBloq OnClick=@(async () => { await DeletarEnderecoEnderecoAsync(end); }) Color="Color.Error" Variant="Variant.Filled">Deletar</MudButton>
                            </MudStack>
                        </MudStack>
                    }

                    @*Aba para adicionar um novo endereço*@
                    @if (NovoEndereco is not null)
                    {

                        <MudStack>
                            <MudText Class="m-2" Typo="Typo.subtitle1">Novo Endereço:</MudText>
                            <MudGrid Class="p-2 mb-1">
                                <MudItem xs="8" md="8" lg="8" xxl="8">
                                    <MudTextField Disabled=false T="string" @bind-Value=@NovoEndereco.Rua Immediate=true Label="Rua" Variant="Variant.Outlined" FullWidth="true" />
                                </MudItem>
                                <MudItem xs="4" md="4" lg="4" xxl="4">
                                    <MudTextField Disabled=false T="string" @bind-Value=@NovoEndereco.Numero Immediate=true Label="Numero" Variant="Variant.Outlined" FullWidth="true" />
                                </MudItem>
                                <MudItem xs="4" md="4" lg="4" xxl="4">
                                    <MudTextField Disabled=false T="string" @bind-Value=@NovoEndereco.Bairro Immediate=true Label="Bairro" Variant="Variant.Outlined" FullWidth="true" />
                                </MudItem>
                                <MudItem xs="4" md="4" lg="4" xxl="4">
                                    <MudSelect T="string"
                                               Label="UF"
                                               Variant="Variant.Outlined"
                                               FullWidth="true"
                                               Disabled="false"
                                               @bind-Value="NovoEndereco.Uf">
                                        @foreach (var uf in Ufs)
                                        {
                                            <MudSelectItem Value="@uf">@uf</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="4" md="4" lg="4" xxl="4">
                                    <MudTextField T="string" @bind-Value=@NovoEndereco.Cep Immediate=true Label="CEP" Variant="Variant.Outlined" FullWidth="true" />
                                </MudItem>
                            </MudGrid>
                            <MudStack Class="p-3" AlignItems="AlignItems.End" Justify="Justify.FlexEnd">
                                <MudButton OnClick=@(async () => { await AdicionarNovoEnderecoAsync(); }) Color="Color.Primary" Variant="Variant.Filled">Adicionar</MudButton>
                            </MudStack>
                        </MudStack>

                    }
                }
            </MudPaper>

            @*Documentos das Empresa*@
            <MudPaper Class="rounded-5 p-2 mt-4" Style="background-color: var(--mud-palette-surface); border: 3px solid var(--mud-palette-primary)" Elevation="2">
                <MudStack AlignItems="AlignItems.Center" Spacing=5 Justify="Justify.Center" Row=true>
                    <MudPaper Class="rounded-5 p-3 w-75" Style="background-color: var(--mud-palette-background);" Elevation="2">
                        <MudText Align="Align.Center" Typo="Typo.h4">Documentos da Empresa</MudText>
                    </MudPaper>
                    <MudButton OnClick=@(() => { EditandoDocumentosBloq = !EditandoDocumentosBloq; }) Color=Color.Primary Size=Size.Large EndIcon="@Icons.Material.Filled.Edit"></MudButton>
                    <MudIconButton OnClick=@(() => { AdicionandoNovoDocumento = !AdicionandoNovoDocumento; if (AdicionandoNovoDocumento) { NovoDocumentoMerchant = new DocumentosMerchant() { }; } else { NovoDocumentoMerchant = null; } }) Color=Color.Primary Size=Size.Large Icon="@Icons.Material.Filled.Add" />
                </MudStack>
                @foreach (var doc in Merchant.Documentos)
                {
                    <MudStack>
                        <MudText Class="m-2" Typo="Typo.subtitle1">Documento:</MudText>
                        <MudGrid Class="p-2 mb-1">
                            <MudItem xs="8" md="8" lg="8" xxl="8">
                                <MudTextField Disabled=EditandoDocumentosBloq @onfocusout=@(async () => { await DeletarEEditarDocumentoAsync(doc, true); }) T="string" @bind-Value=@doc.Cnpj Immediate=true Label="CNPJ" Variant="Variant.Outlined" FullWidth="true" />
                            </MudItem>
                            <MudItem xs="4" md="4" lg="4" xxl="4">
                                <MudTextField Disabled=EditandoDocumentosBloq @onfocusout=@(async () => { await DeletarEEditarDocumentoAsync(doc, true); }) T="string" @bind-Value=@doc.InscricaoMunicipal Immediate=true Label="Inscricao Municipal" Variant="Variant.Outlined" FullWidth="true" />
                            </MudItem>
                            <MudItem xs="8" md="8" lg="8" xxl="8">
                                <MudTextField Disabled=EditandoDocumentosBloq @onfocusout=@(async () => { await DeletarEEditarDocumentoAsync(doc, true); }) T="string" @bind-Value=@doc.IncricaoEstadual Immediate=true Label="Inscricao Municipal" Variant="Variant.Outlined" FullWidth="true" />
                            </MudItem>
                            <MudItem xs="4" md="4" lg="4" xxl="4">
                                <MudTextField Disabled=EditandoDocumentosBloq @onfocusout=@(async () => { await DeletarEEditarDocumentoAsync(doc, true); }) T="string" @bind-Value=@doc.Cnae Immediate=true Label="CNAE" Variant="Variant.Outlined" FullWidth="true" />
                            </MudItem>

                        </MudGrid>
                        <MudStack Class="p-3" AlignItems="AlignItems.End" Justify="Justify.FlexEnd">
                            <MudButton Disabled=EditandoDocumentosBloq OnClick=@(async () => { await DeletarEEditarDocumentoAsync(doc); }) Color="Color.Error" Variant="Variant.Filled">Deletar</MudButton>
                        </MudStack>
                    </MudStack>
                }

                @if (NovoDocumentoMerchant is not null && AdicionandoNovoDocumento)
                {
                    <MudStack>
                        <MudText Class="m-2" Typo="Typo.subtitle1">Documento:</MudText>
                        <MudGrid Class="p-2 mb-1">
                            <MudItem xs="8" md="8" lg="8" xxl="8">
                                <MudTextField T="string" @bind-Value=@NovoDocumentoMerchant.Cnpj Immediate=true Label="CNPJ" Variant="Variant.Outlined" FullWidth="true" />
                            </MudItem>
                            <MudItem xs="4" md="4" lg="4" xxl="4">
                                <MudTextField T="string" @bind-Value=@NovoDocumentoMerchant.InscricaoMunicipal Immediate=true Label="Inscricao Municipal" Variant="Variant.Outlined" FullWidth="true" />
                            </MudItem>
                            <MudItem xs="8" md="8" lg="8" xxl="8">
                                <MudTextField T="string" @bind-Value=@NovoDocumentoMerchant.IncricaoEstadual Immediate=true Label="Inscricao Estadual" Variant="Variant.Outlined" FullWidth="true" />
                            </MudItem>
                            <MudItem xs="4" md="4" lg="4" xxl="4">
                                <MudTextField T="string" @bind-Value=@NovoDocumentoMerchant.Cnae Immediate=true Label="CNAE" Variant="Variant.Outlined" FullWidth="true" />
                            </MudItem>

                        </MudGrid>
                        <MudStack Class="p-3" AlignItems="AlignItems.End" Justify="Justify.FlexEnd">
                            <MudButton OnClick=@(async () => { await AdicionarNovoDocumentoAsync(); }) Color="Color.Primary" Variant="Variant.Filled">Adicionar</MudButton>
                        </MudStack>
                    </MudStack>
                }
            </MudPaper>
        }
        else
        {

        }
    </MudLayout>
</MudPaper>

@code {
    #region Propriedades
    //props de loja
    private ClsMerchant? Merchant = new();
    private ClsMerchant? MerchantParaComparacao = new();
    private string CertificadoCarregado = string.Empty;

    //props auxiliares
    private bool Carregando = false;
    private bool EditandoInfosLojaBloq = true;
    private bool EditandoInfosFiscaisBloq = true;
    private bool EditandoInfosEntregaBloq = true;
    private bool CarregouNovoCertificado = false;
    private bool EditandoEnderecosBloq = true;
    private bool EditandoDocumentosBloq = true;

    //props para ajudar a adicionar um novo endereco
    private EnderecoMerchant? NovoEndereco = null;
    private bool AdicionandoNovoEndereco = false;

    //props para ajudar a adicionar um novo documento
    private DocumentosMerchant? NovoDocumentoMerchant = null;
    private bool AdicionandoNovoDocumento = false;

    #region Ufs
    private readonly string[] Ufs =
    {
        "AC","AL","AP","AM","BA","CE","DF","ES","GO","MA",
        "MT","MS","MG","PA","PB","PR","PE","PI","RJ","RN",
        "RS","RO","RR","SC","SP","SE","TO"
    };
    #endregion
    #endregion


    #region Funcao De Inicialização da página
    protected override async Task OnInitializedAsync()
    {
        try
        {
            Merchant = await MerchantServices.GetMerchantAsync();
            MerchantParaComparacao = Merchant;

            if (Merchant is not null && !string.IsNullOrEmpty(Merchant.CertificadoBase64))
            {
                CertificadoCarregado = Merchant.CertificadoBase64;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar dados da loja: {ex.Message}", Severity.Error);
        }
        finally
        {
            Carregando = false;
        }
    }
    #endregion

    #region Funcoes Auxiliares
    private async Task SalvarInfosLojaAsync()
    {
        try
        {
            if (Merchant is not null && MerchantParaComparacao is not null)
            {
                var resultado = await MerchantServices.UpdateMerchantAsync(Merchant);
                var sucesso = resultado.Status == "success" ? true : false;
                string mensagem = sucesso ? string.Join(",", resultado.Data.Messages) : string.Join(",", resultado.Messages);
                Snackbar.Add(mensagem, sucesso ? Severity.Success : Severity.Error);

                EditandoInfosLojaBloq = true;
                EditandoInfosFiscaisBloq = true;
                CarregouNovoCertificado = false;
                MerchantParaComparacao = Merchant;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar dados da loja: {ex.Message}", Severity.Error);
        }
    }

    private async void UploadCertificado(IBrowserFile file)
    {
        using var stream = file.OpenReadStream();
        using var ms = new MemoryStream();

        await stream.CopyToAsync(ms);

        byte[] certificadoBytes = ms.ToArray();
        string base64 = Convert.ToBase64String(certificadoBytes);

        CertificadoCarregado = base64;
        CarregouNovoCertificado = true;
        StateHasChanged();
    }

    #region Funções de select
    private async Task OnEmitindoNfeProdChanged(bool valor)
    {
        if (Merchant is null)
            return;

        Merchant.EmitindoNfeProd = valor;
        await SalvarInfosLojaAsync();
    }

    private async Task OnMudBoxCheckedChenged(bool valor)
    {
        if (Merchant is null)
            return;

        Merchant.EnviaPedidoAutTaxyMachine = valor;
        await SalvarInfosLojaAsync();
    }

    private async Task OnMudCheckBoxChangedGenerico(bool valor, Action<bool> setValor)
    {
        if (Merchant is null)
            return;

        setValor(valor);
        await SalvarInfosLojaAsync();
    }
    #endregion

    private async Task AdicionarNovoEnderecoAsync()
    {
        try
        {
            if (Merchant is not null && NovoEndereco is not null)
            {
                var resultado = await MerchantServices.CreateEnderecoParaMerchant(NovoEndereco);

                var sucesso = resultado.Status == "success" ? true : false;
                string mensagem = sucesso ? string.Join(",", resultado.Data.Messages) : string.Join(",", resultado.Messages);
                Snackbar.Add(mensagem, sucesso ? Severity.Success : Severity.Error);

                if (sucesso)
                {
                    Merchant.EnderecosMerchant.Add(NovoEndereco);
                    AdicionandoNovoEndereco = false;
                    NovoEndereco = null;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar dados da loja: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeletarEnderecoEnderecoAsync(EnderecoMerchant Endereco)
    {
        try
        {
            var resultado = await MerchantServices.DeleteEndereco(Endereco);

            var sucesso = resultado.Status == "success" ? true : false;
            string mensagem = sucesso ? string.Join(",", resultado.Data.Messages) : string.Join(",", resultado.Messages);
            Snackbar.Add(mensagem, sucesso ? Severity.Success : Severity.Error);

            if (sucesso && Merchant is not null)
            {
                Merchant.EnderecosMerchant.Remove(Endereco);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar dados da loja: {ex.Message}", Severity.Error);
        }
    }

    private async Task AtualizarEnderecoEnderecoAsync(EnderecoMerchant Endereco)
    {
        try
        {
            var resultado = await MerchantServices.UpdateEndereco(Endereco);

            var sucesso = resultado.Status == "success" ? true : false;
            string mensagem = sucesso ? string.Join(",", resultado.Data.Messages) : string.Join(",", resultado.Messages);
            Snackbar.Add(mensagem, sucesso ? Severity.Success : Severity.Error);

            if (sucesso && Merchant is not null)
            {
                EditandoEnderecosBloq = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar dados da loja: {ex.Message}", Severity.Error);
        }
    }

    private async Task AdicionarNovoDocumentoAsync()
    {
        try
        {
            if (Merchant is not null && NovoDocumentoMerchant is not null)
            {
                var resultado = await MerchantServices.CreateDocumentoParaMerchant(NovoDocumentoMerchant);

                var sucesso = resultado.Status == "success" ? true : false;
                string mensagem = sucesso ? string.Join(",", resultado.Data.Messages) : string.Join(",", resultado.Messages);
                Snackbar.Add(mensagem, sucesso ? Severity.Success : Severity.Error);

                if (sucesso)
                {
                    Merchant.Documentos.Add(NovoDocumentoMerchant);
                    AdicionandoNovoDocumento = false;
                    NovoDocumentoMerchant = null;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar dados da loja: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeletarEEditarDocumentoAsync(DocumentosMerchant Documento, bool editandoDocumento = false)
    {
        try
        {
            if (Merchant is null)
                return;

            ReturnApiRefatored<DocumentosMerchant> resultado;

            if (!editandoDocumento)
            {
                resultado = await MerchantServices.DeleteDocumento(Documento);
            }
            else
            {
                resultado = await MerchantServices.UpdateDocumento(Documento);
            }

            var sucesso = resultado.Status == "success" ? true : false;
            string mensagem = sucesso ? string.Join(",", resultado.Data.Messages) : string.Join(",", resultado.Messages);
            Snackbar.Add(mensagem, sucesso ? Severity.Success : Severity.Error);

            if (sucesso && !editandoDocumento)
            {
                Merchant.Documentos.Remove(Documento);
            }

            StateHasChanged();

        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar dados da loja: {ex.Message}", Severity.Error);
        }
    }


    #endregion
}


