@rendermode RenderMode.InteractiveWebAssembly
@attribute [Authorize]

@page "/"
@using FrontMenuWeb.Models.Pedidos

@inject PedidosService PedidosService
@inject CaixaEPagamentosService CaixaService

<MudStack Class="pagina-home min-vh-100">

    @if (AvisoDeCaixaFechado)
    {
        <MudAlert CloseIconClicked=@(() => { AvisoDeCaixaFechado = !AvisoDeCaixaFechado; }) Icon="@Icons.Material.Filled.Notifications" CloseIcon="@Icons.Material.Filled.Close" ShowCloseIcon=true Severity="@SeverityCaixa">
            @MensagemDeCaixa
        </MudAlert>
    }
    <!-- Alertas e Notificações -->
    @if (AvisoDePedidosAguardando)
    {
        <MudAlert CloseIconClicked=@(() => { AvisoDePedidosAguardando = !AvisoDePedidosAguardando; }) CloseIcon="@Icons.Material.Filled.Close" Icon="@Icons.Material.Filled.Notifications" ShowCloseIcon=true Severity="Severity.Info">
            Você tem @NumeroDePedidosAbertos Pedidos Abertos.
        </MudAlert>
    }


    <MudGrid Class="pa-4" Spacing="3">

        @if (!UsuarioPermitidoAcessarDashboard)
        {
            <div class="overlay-blur">
                <div class="overlay-conteudo">
                    <MudIcon Icon="@Icons.Material.Filled.Block" Size="Size.Large" Color="Color.Error" />
                    <MudText Typo="Typo.h5" Class="mt-2">Acesso Negado</MudText>
                    <MudText Typo="Typo.body1">
                        Infelizmente o seu perfil de usuário não permite acesso à Dashboard. Caso precise dessa funcionalidade, solicite autorização ao administrador.
                    </MudText>
                </div>
            </div>
        }


        <!-- Cards de métricas -->
        <MudItem xs="12" sm="4" Style="cursor:pointer" @onclick=ClickTiketMedio>
            <MudCard Class="pa-4" Style="background: linear-gradient(135deg, #FF9800, #F57C00); color:white;">
                <MudCardContent>
                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Large" />
                    <MudText Typo="Typo.h6">Vendas Hoje</MudText>
                    <MudText Typo="Typo.h4" Class="font-weight-bold">@ValorTotalVendasHoje.ToString("C")</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="4" Style="cursor:pointer" @onclick=ClickCardPedidos>
            <MudCard Class="pa-4" Style="background: linear-gradient(135deg, #4CAF50, #2E7D32); color:white;">
                <MudCardContent>
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Large" />
                    <MudText Typo="Typo.h6">Total de Pedidos</MudText>
                    <MudText Typo="Typo.h4" Class="font-weight-bold">@NumeroTotalDePedidos</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="4" Style="cursor:pointer" @onclick=ClickTiketMedio>
            <MudCard Class="pa-4" Style="background: linear-gradient(135deg, #2196F3, #1565C0); color:white;">
                <MudCardContent>
                    <MudIcon Icon="@Icons.Material.Filled.ReceiptLong" Size="Size.Large" />
                    <MudText Typo="Typo.h6">Ticket Médio</MudText>
                    <MudText Typo="Typo.h4" Class="font-weight-bold">@TicketMedioHoje.ToString("C")</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Barras de progresso -->
        <MudItem xs="12" sm="4">
            <MudCard>
                <MudCardContent>
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Color="Color.Primary" />
                        <MudText>Delivery - @($"{PercentualPedidosDelivery:F1}")% </MudText>
                    </MudStack>
                    <MudProgressLinear Color="Color.Primary" Value="PercentualPedidosMesa" Rounded />
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudCard>
                <MudCardContent>
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Storefront" Color="Color.Info" />
                        <MudText>Balcão - @($"{PercentualPedidosBalcao:F1}")%</MudText>
                    </MudStack>
                    <MudProgressLinear Color="Color.Info" Value="PercentualPedidosBalcao" Rounded />
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudCard>
                <MudCardContent>
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Restaurant" Color="Color.Secondary" />
                        <MudText>Mesas - @($"{PercentualPedidosMesa:F1}")% </MudText>
                    </MudStack>
                    <MudProgressLinear Color="Color.Secondary" Value="PercentualPedidosMesa" Rounded />
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
    <!-- Filtros e Tabela de Pedidos -->
    <MudCard Class="pa-4" Elevation="3">
        <MudCardHeader>
            <MudText Typo="Typo.h6">Pedidos Recentes</MudText>
        </MudCardHeader>
        <MudCardContent>            
            <!-- Tabela de Pedidos -->
            <MudTable Items="@pedidosFiltrados" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
                <HeaderContent>
                    <MudTh>Nº Pedido</MudTh>
                    <MudTh>Cliente</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Valor</MudTh>
                    <MudTh>Hora</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Id</MudTd>
                    <MudTd>@context.Cliente?.Nome</MudTd>
                    <MudTd>

                    </MudTd>
                    <MudTd>@(context.Pagamentos.Sum(p => p.ValorTotal).ToString("C"))</MudTd>
                    <MudTd> @(context.CriadoEm.ToString("HH:mm"))</MudTd>    
                </RowTemplate>
            </MudTable>
        </MudCardContent>
    </MudCard>
</MudStack>

@code {
    private bool drawerOpen = true;
    private DateTime ultimaAtualizacao = DateTime.Now;
    private string filtroBusca = "";
    private DateTime? dataSelecionada = DateTime.Today;
    private string statusSelecionado = "Todos";

    private bool AvisoDePedidosAguardando = true;
    private bool AvisoDeCaixaFechado = true;
    private string MensagemDeCaixa = "Carregando informações de caixa ...";
    private Severity SeverityCaixa = Severity.Error;

    private bool UsuarioPermitidoAcessarDashboard = true;


    private int NumeroTotalDePedidos = 0;
    private int NumeroDePedidosAbertos = 0;

    private float ValorTotalVendasHoje = 0.0f;
    private float TicketMedioHoje = 0.0f;
    private float PercentualPedidosMesa = 0.0f;
    private float PercentualPedidosBalcao = 0.0f;
    private float PercentualPedidosDelivery = 0.0f;

    // Lista de pedidos
    private List<ClsPedido> pedidos = new List<ClsPedido>();
    private List<ClsPedido> pedidosFiltrados = new List<ClsPedido>();
    
    //timer para atualização automática
    private PeriodicTimer? _timer;
    private CancellationTokenSource _cts = new();


    protected override void OnInitialized()
    {
        pedidosFiltrados = new List<ClsPedido>(pedidos);
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Recebido" => Color.Info,
            "Em preparo" => Color.Warning,
            "Pronto" => Color.Success,
            "Entregue" => Color.Default,
            _ => Color.Default
        };
    }

    private void FiltrarPedidos()
    {

        StateHasChanged();
    }

    private void AtualizarDados()
    {
        ultimaAtualizacao = DateTime.Now;
        StateHasChanged();
    }


    protected override async Task OnInitializedAsync()
    {
        try
        {
            await AtualizaInfosDosPedidos();

            if (AppState.MerchantLogado.FuncionarioLogado is not null)
            {
                if (AppState.MerchantLogado.FuncionarioLogado.AcessoDashboard)
                {
                    UsuarioPermitidoAcessarDashboard = true;
                }
                else
                {
                    UsuarioPermitidoAcessarDashboard = false;
                }
            }
            else
            {
                UsuarioPermitidoAcessarDashboard = true;
            }


            _timer = new PeriodicTimer(TimeSpan.FromSeconds(30));

            _ = Task.Run(async () =>
            {
                try
                {
                    while (await _timer.WaitForNextTickAsync(_cts.Token))
                    {
                        await InvokeAsync(async () =>
                        {
                            await AtualizaInfosDosPedidos();
                            StateHasChanged();
                        });
                    }
                }
                catch (OperationCanceledException)
                {
                    // cancelado
                }
            });

        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar dados: {ex.Message}", Severity.Error);
        }
    }

    public async Task AtualizaInfosDosPedidos()
    {
        ReturnApiRefatored<ClsPedido> returno = await CaixaService.VerificaSeHaCaixaAberto(AppState.MerchantLogado.FuncionarioLogado?.Id);

        if (returno.Status == "error")
        {
            MensagemDeCaixa = string.Join(" - ", returno.Messages);
            SeverityCaixa = Severity.Error;
        }
        else
        {
            MensagemDeCaixa = string.Join(" - ", returno.Data.Messages);
            SeverityCaixa = Severity.Success;
        }

        PaginatedResponse<ClsPedido> retornoPedidosTotal = await PedidosService.GetPedidosPorPaginaAsync(new QuerysDePedidos() { Page = 1, PageSize = 5 });
        if (retornoPedidosTotal.Total > 0)
        {
            NumeroTotalDePedidos = retornoPedidosTotal.Total;
            TicketMedioHoje = retornoPedidosTotal.TiketMedio;
            ValorTotalVendasHoje = retornoPedidosTotal.VendasHoje;
            pedidos = retornoPedidosTotal.Data;
            pedidosFiltrados = pedidos;

        }

        if(retornoPedidosTotal.PercentualDePedidos is not null)
        {
            PercentualPedidosBalcao = retornoPedidosTotal.PercentualDePedidos.Balcao;
            PercentualPedidosDelivery = retornoPedidosTotal.PercentualDePedidos.Delivery;
            PercentualPedidosMesa = retornoPedidosTotal.PercentualDePedidos.Mesa;
        }

        var retornoPedidosAbertos = await PedidosService.GetPedidosPorPaginaAsync(new QuerysDePedidos() { Page = 1, PageSize = 1, Status = StatusPedidos.ABERTO });
        if (retornoPedidosAbertos.Total > 0)
        {
            NumeroDePedidosAbertos = retornoPedidosAbertos.Total;
            TicketMedioHoje = retornoPedidosTotal.TiketMedio;
            ValorTotalVendasHoje = retornoPedidosTotal.VendasHoje;
        }

       

    }

    private void ClickCardPedidos()
    {
        Navigation.NavigateTo("/gestao-de-pedidos");
    }

    private void ClickTiketMedio()
    {
        Navigation.NavigateTo("/vendas/historico-de-vendas");
    }
}