@rendermode RenderMode.InteractiveWebAssembly
@attribute [Authorize]
@page "/produtos"
@using FrontMenuWeb.Components.Modais.ModaisDeGrupo
@using FrontMenuWeb.Services
@using Microsoft.AspNetCore.Components
@using System.Globalization;
@using MudBlazor.Extensions
@using MudBlazor.Extensions.Components
@inject GrupoServices GrupoService
@inject ISnackbar Snackbar
@inject IHttpClientFactory HttpClientFactory
@inject ProdutoService ProdutoService

<MudPaper Square="false" Elevation="0" Style="background-color: var(--mud-palette-background); min-height: 100vh; margin-top:50px">
    <MudLayout>
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <MudText Typo="Typo.h4">Produtos</MudText>
                <MudText Class="mb-3" Typo="Typo.body1">Lista de produtos cadastrados.</MudText>
            </div>
            <div>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="rounded-1 " style="color: white">Novo Produto</MudButton>
            </div>
        </div>


        <MudDataGrid T="ClsProduto" Items="@Produtos" class="rounded-3">
            <ToolBarContent>
                <div class="d-flex align-items-center justify-content-between w-50">
                    <div>
                    </div>
                    <div>
                    </div>
                </div>
                <MudTextField AdornmentIcon="@Icons.Material.Outlined.Search" Adornment="Adornment.End" Placeholder="Pesquisar Produto"
                              @bind-Value="StringDePesquisa" @bind-Value:after="@(() => RecarregarProdutosAposPesquisa())"
                              DebounceInterval="100" Variant="Variant.Outlined" Clearable />
            </ToolBarContent>
            <Columns>
                <HierarchyColumn T="ClsProduto" EnableHeaderToggle="@_enableHeaderToggle" />
                <PropertyColumn Property="x => x.Descricao" Title="Nome" />
                <PropertyColumn Property="x => x.CodigoInterno" Title="Codigo" />
                <TemplateColumn T="ClsProduto" Hidden="false" Title="Precos">
                    <CellTemplate Context="context">
                        @foreach (var preco in context.Item.Precos)
                        {
                            <MudGrid>
                                <MudItem xs="6">
                                    <MudPaper Elevation="0" Square="false" Class="d-flexjustify-content-center align-items-center">
                                        <MudText>@preco.DescricaoDoTamanho</MudText>
                                        <MudNumericField Immediate="false"
                                                         AdornmentColor="Color.Primary"
                                                         Format="N2"
                                                         Culture="_pt"
                                                         T="double"
                                                         Class="mt-2"
                                                         HideSpinButtons="true"
                                                         @bind-Value="preco.Valor"
                                                         @onfocusout="@(() => AtualizaValorDoProduto(preco))" />

                                        <MudSwitch Disabled="true" Color="Color.Primary" />
                                    </MudPaper>
                                </MudItem>
                            </MudGrid>

                        }
                    </CellTemplate>
                </TemplateColumn>

                <TemplateColumn T="ClsProduto" Title="Deletar">
                    <CellTemplate Context="context">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <ChildRowContent>
                <MudCard Class="w-100 p-0" style="background-color: var(--mud-palette-background);">
                    <MudCardHeader>
                        <CardHeaderContent>

                            <MudItem xs="12">
                                <MudPaper Class="d-flex flex-column align-center justify-center mud-width-fulloverflow-hidden" style="word-break: break-word;">
                                    <MudPaper Elevation="0" Square="false" Class="d-flex align-center justify-center mud-width-full">  <MudText Color="Color.Primary" Typo="Typo.h6">@context.Item.Descricao</MudText> </MudPaper>

                                    <MudStepper NonLinear Ripple="false" ScrollableNavigation="false" Class=" align-center justify-center mud-width-full" style="overflow-x: auto;">
                                        <ChildContent>
                                            <MudStep onclick="@(()=> TrocaAbaDeInfosDoProduto(1))" Completed="false" Title="Principal">Informações do produto, como nome, valores, impressão e etc ...</MudStep>
                                            <MudStep onclick="@(()=> TrocaAbaDeInfosDoProduto(2))" Completed="false" Title=" Tributações">Informações de tributação do produto</MudStep>
                                            <MudStep onclick="@(()=> TrocaAbaDeInfosDoProduto(3))" Completed="false" Title=" Ficha Técnica">Ficha técnica do produto</MudStep>
                                        </ChildContent>
                                        <ActionContent Context="stepper">
                                            @*
                                            Deixar Vazio para não ter botões de ação
                                        *@
                                        </ActionContent>
                                    </MudStepper>


                                </MudPaper>
                            </MudItem>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (NumAba == 1)
                        {
                            <MudGrid>
                                <MudItem xs="12">
                                    <MudPaper Class="d-flex align-center justify-center mud-width-full py-8">
                                        <MudTextField @bind-Value=@context.Item.CodigoInterno Disabled="true" Class="w-25 m-2" Label="Codigo do produto" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
                                        <MudTextField @bind-Value=@context.Item.Descricao @onfocusout=@(prop=> OnSaveChanges(context.Item)) Class="w-75 m-2" Label="Nome do produto" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
                                    </MudPaper>
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudPaper Class="d-flex align-center justify-center mud-width-full py-8">
                                        <MudSelect @bind-Value="context.Item.Grupo"
                                                   SelectedValuesChanged=@(prop=> OnSaveChanges(context.Item))
                                                   T="ClsGrupo"
                                                   Class="m-3"
                                                   ToStringFunc="g=> g.Descricao"
                                                   Label="Grupo selecionado"
                                                   HelperText="Grupo"
                                                   Placeholder="Escolha seu grupo"
                                                   AdornmentIcon="@Icons.Material.Filled.Fastfood"
                                                   AdornmentColor="Color.Success">

                                            @foreach (var grupo in Grupos)
                                            {
                                                <MudSelectItem Value="@grupo">@grupo.Descricao</MudSelectItem>
                                            }
                                        </MudSelect>
                                    </MudPaper>
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudPaper Class="d-flex align-center justify-center mud-width-full py-8">
                                        <MudSelect @bind-Value="context.Item.Categoria"
                                                   T="Categoria"
                                                   Class="m-3"
                                                   ToStringFunc="g=> g.Descricao"
                                                   Label="Categoria selecionada"
                                                   HelperText="Categoria"
                                                   Placeholder="Categoria Selecionada"
                                                   AdornmentIcon="@Icons.Material.Filled.FoodBank"
                                                   AdornmentColor="Color.Success"
                                                   Disabled="true">
                                        </MudSelect>
                                    </MudPaper>
                                </MudItem>
                                <MudItem xs="6" sm="6">
                                    <MudPaper>
                                        <MudPaper Elevation="0" Square="false" Class="d-flex align-items-center justify-content-center fw-bold"> Impressoras </MudPaper>
                                        <MudPaper Elevation="0" Square="false" Class="d-flex flex-wrap gap-2 justify-between mud-width-full py-8">



                                            <MudSelect Class="m-2"
                                                       @bind-Value="@context.Item.ImpressoraComanda1"
                                                       T="string"
                                                       SelectedValuesChanged=@(prop=> OnSaveChanges(context.Item))
                                                       Label="Comanda 1"
                                                       HelperText="Local de impressão"
                                                       Placeholder="Local de impressão"
                                                       AdornmentIcon="@Icons.Material.Filled.ShareLocation"
                                                       AdornmentColor="Color.Success">

                                                <MudSelectItem Value="@("Cz1")">Cozinha 1</MudSelectItem>
                                                <MudSelectItem Value="@("Cz2")">Cozinha 2</MudSelectItem>
                                                <MudSelectItem Value="@("Cz3")">Cozinha 3</MudSelectItem>
                                                <MudSelectItem Value="@("Bar")">Bar</MudSelectItem>
                                                <MudSelectItem Value="@("Nao")">Não Imprime</MudSelectItem>

                                            </MudSelect>

                                            <MudSelect Class="m-2"
                                                       @bind-Value="@context.Item.ImpressoraComanda2"
                                                       T="string"
                                                       SelectedValuesChanged=@(prop=> OnSaveChanges(context.Item))
                                                       Label="Comanda 2"
                                                       HelperText="Local de impressão"
                                                       Placeholder="Local de impressão"
                                                       AdornmentIcon="@Icons.Material.Filled.ShareLocation"
                                                       AdornmentColor="Color.Success">

                                                <MudSelectItem Value="@("Cz1")">Cozinha 1</MudSelectItem>
                                                <MudSelectItem Value="@("Cz2")">Cozinha 2</MudSelectItem>
                                                <MudSelectItem Value="@("Cz3")">Cozinha 3</MudSelectItem>
                                                <MudSelectItem Value="@("Bar")">Bar</MudSelectItem>
                                                <MudSelectItem Value="@("Nao")">Não Imprime</MudSelectItem>

                                            </MudSelect>





                                        </MudPaper>
                                    </MudPaper>
                                </MudItem>
                                <MudItem xs="6" sm="6">
                                    @*Cardapio do dia*@
                                    <MudPaper>
                                        <MudPaper Elevation="0" Square="false" Class="d-flex align-items-center justify-content-center fw-bold"> Cardápío do dia </MudPaper>


                                        <MudPaper Elevation="0" Square="false" Class="d-flex align-items-center justify-content-center mt-4">
                                            <MudRadioGroup T="bool"
                                                           Value="context.Item.CardapioDoDia"
                                                           ValueChanged="@(valor => { context.Item.CardapioDoDia = valor; OnSaveChanges(context.Item); })">
                                                <MudRadio Value="true" Color="Color.Success" Dense="true">Sim</MudRadio>
                                                <MudRadio Value="false" Color="Color.Error" Dense="false">Não</MudRadio>
                                            </MudRadioGroup>
                                        </MudPaper>

                                        <MudPaper Elevation="0" Class="d-flex flex-wrap gap-1 justify-content-around align-items-center w-100 mt-2" Square="false">

                                            <MudPaper Elevation="0" Square="false">
                                                <MudNumericField T="int"
                                                                 Value="context.Item.QtdBase"
                                                                 Immediate="false"
                                                                 ValueChanged="@(valor => {context.Item.QtdBase = valor; OnSaveChanges(context.Item);})"
                                                                 Label="Qtd Base"
                                                                 Variant="Variant.Outlined"
                                                                 Step="1"
                                                                 Min="0"
                                                                 Max="100" />
                                            </MudPaper>

                                            <MudPaper Elevation="0" Square="false">
                                                <MudNumericField T="int"
                                                                 Value="context.Item.QtdGuarnicao"
                                                                 Immediate="false"
                                                                 ValueChanged="@(valor => {context.Item.QtdGuarnicao = valor; OnSaveChanges(context.Item);})"
                                                                 Label="Qtd Guarnição"
                                                                 Variant="Variant.Outlined"
                                                                 Step="1"
                                                                 Min="0"
                                                                 Max="100" />
                                            </MudPaper>


                                            <MudPaper Elevation="0" Square="false">
                                                <MudNumericField T="int"
                                                                 Value="context.Item.QtdCarnes"
                                                                 Immediate="false"
                                                                 ValueChanged="@(valor => {context.Item.QtdCarnes = valor; OnSaveChanges(context.Item);})"
                                                                 Label="Qtd Carnes"
                                                                 Variant="Variant.Outlined"
                                                                 Step="1"
                                                                 Min="0"
                                                                 Max="100" />
                                            </MudPaper>




                                        </MudPaper>



                                    </MudPaper>
                                </MudItem>
                                <MudItem xs="12" sm="12">
                                    <MudPaper Class="d-flex flex-wrap gap-2 justify-content-around w-100 py-8">
                                        <MudPaper Elevation="0" Square="false">
                                            <MudText> Tamanho Unico ? </MudText>
                                            <MudRadioGroup T="bool"
                                                           Value="context.Item.TamanhoUnico"
                                                           ValueChanged="@(valor => { context.Item.TamanhoUnico = valor; OnSaveChanges(context.Item); })">
                                                <MudRadio Value="true" Color="Color.Success" Dense="true">Sim</MudRadio>
                                                <MudRadio Value="false" Color="Color.Error" Dense="false">Não</MudRadio>
                                            </MudRadioGroup>
                                        </MudPaper>

                                        <MudPaper Elevation="0" Square="false">
                                            <MudText> Item fracionado ? </MudText>
                                            <MudRadioGroup T="bool"
                                                           Value="context.Item.Fracionado"
                                                           ValueChanged="@(valor => { context.Item.Fracionado = valor; OnSaveChanges(context.Item); })">
                                                <MudRadio Value="true" Color="Color.Success" Dense="true">Sim</MudRadio>
                                                <MudRadio Value="false" Color="Color.Error" Dense="false">Não</MudRadio>
                                            </MudRadioGroup>
                                        </MudPaper>

                                        <MudPaper Elevation="0" Square="false">
                                            <MudText> Tipo de Venda </MudText>
                                            <MudRadioGroup T="string"
                                                           Value="context.Item.TipoDeVenda"
                                                           ValueChanged="@(valor => { context.Item.TipoDeVenda = valor; OnSaveChanges(context.Item); })">
                                                <MudRadio Value="@("Q")" Color="Color.Success" Dense="true">
                                                    Qtd
                                                </MudRadio>
                                                <MudRadio Value="@("V")" Color="Color.Success" Dense="false">
                                                    Valor
                                                </MudRadio>
                                            </MudRadioGroup>
                                        </MudPaper>

                                        <MudPaper Elevation="0" Square="false">
                                            <MudText> Obs na venda? </MudText>
                                            <MudRadioGroup T="bool"
                                                           Value="context.Item.ObsNaVenda"
                                                           ValueChanged="@(valor => { context.Item.ObsNaVenda = valor; OnSaveChanges(context.Item); })">
                                                <MudRadio Value="true" Color="Color.Success" Dense="true">Sim</MudRadio>
                                                <MudRadio Value="false" Color="Color.Error" Dense="false">Não</MudRadio>
                                            </MudRadioGroup>
                                        </MudPaper>


                                        <MudPaper Elevation="0" Square="false">
                                            <MudText> Forma de venda </MudText>
                                            <MudRadioGroup T="string"
                                                           Value="context.Item.FormaDeVenda"
                                                           ValueChanged="@(valor => { context.Item.FormaDeVenda = valor; OnSaveChanges(context.Item); })">
                                                <MudRadio Value="@("unidade")" Color="Color.Success" Dense="true">
                                                    Unidade
                                                </MudRadio>
                                                <MudRadio Value="@("peso")" Color="Color.Success" Dense="false">
                                                    Peso
                                                </MudRadio>
                                            </MudRadioGroup>
                                        </MudPaper>

                                    </MudPaper>
                                </MudItem>

                                @*Valores*@
                                <MudItem xs="12">

                                    <MudGrid>

                                        @if (!context.Item.TamanhoUnico)
                                        {
                                            @foreach (var preco in context.Item.Precos)
                                            {
                                                <MudItem xs="12">
                                                    <MudPaper Class="d-flex flex-wrap gap-2 align-center justify-center mud-width-full py-8">


                                                        <MudTextField @onfocusout="@(() => AtualizaValorDoProduto(preco))"
                                                                      @bind-Value="preco.DescricaoDoTamanho"
                                                                      Disabled="false"
                                                                      Class="w-25 m-2"
                                                                      Label="Descrição do Tamanho"
                                                                      HelperText="Descrição do tamanho"
                                                                      Variant="Variant.Text"
                                                                      Margin="Margin.Dense" />

                                                        <MudTextField @bind-Value="preco.CustosDoInsumo" Disabled="true" Class="w-25 m-2" Label="Custos Insumo" HelperText="Custos dos insumos" Variant="Variant.Text" Margin="Margin.Dense" />

                                                        <MudTextField @bind-Value="preco.CustoReal" Disabled="true" Class="w-25 m-2" Label="Custos reais" HelperText="Custos reais" Variant="Variant.Text" Margin="Margin.Dense" />

                                                        <MudTextField @bind-Value="preco.PorcentagemDeLucro" Disabled="true" Class="w-25 m-2" Label="% de lucro" HelperText="% de lucro" Variant="Variant.Text" Margin="Margin.Dense" />

                                                        <MudNumericField Immediate="false"
                                                                         Label="Valor do tamanho"
                                                                         Format="N2"
                                                                         Culture="_pt"
                                                                         T="double"
                                                                         HideSpinButtons="true"
                                                                         @bind-Value="preco.Valor"
                                                                         @onfocusout="@(() => AtualizaValorDoProduto(preco))" />


                                                    </MudPaper>
                                                </MudItem>
                                            }

                                        }
                                        else
                                        {
                                            var precoMenor = context.Item.Precos
                                            .OrderBy(x => x.Valor)
                                            .FirstOrDefault() ?? new Preco() { DescricaoDoTamanho = "Sem preço definido", Valor = 0.0 };

                                            <MudItem xs="12">
                                                <MudPaper Class="d-flex flex-wrap gap-2 align-center justify-center mud-width-full py-8">


                                                    <MudTextField @onfocusout="@(() => AtualizaValorDoProduto(precoMenor))"
                                                                  @bind-Value="precoMenor.DescricaoDoTamanho"
                                                                  Disabled="false"
                                                                  Class="w-25 m-2"
                                                                  Label="Descrição do Tamanho"
                                                                  HelperText="Descrição do tamanho"
                                                                  Variant="Variant.Text"
                                                                  Margin="Margin.Dense" />

                                                    <MudTextField @bind-Value="precoMenor.CustosDoInsumo" Disabled="true" Class="w-25 m-2" Label="Custos Insumo" HelperText="Custos dos insumos" Variant="Variant.Text" Margin="Margin.Dense" />

                                                    <MudTextField @bind-Value="precoMenor.CustoReal" Disabled="true" Class="w-25 m-2" Label="Custos reais" HelperText="Custos reais" Variant="Variant.Text" Margin="Margin.Dense" />

                                                    <MudTextField @bind-Value="precoMenor.PorcentagemDeLucro" Disabled="true" Class="w-25 m-2" Label="% de lucro" HelperText="% de lucro" Variant="Variant.Text" Margin="Margin.Dense" />

                                                    <MudNumericField Immediate="false"
                                                                     Label="Valor do tamanho"
                                                                     Format="N2"
                                                                     Culture="_pt"
                                                                     T="double"
                                                                     HideSpinButtons="true"
                                                                     @bind-Value="precoMenor.Valor"
                                                                     @onfocusout="@(() => AtualizaValorDoProduto(precoMenor))" />


                                                </MudPaper>
                                            </MudItem>

                                        }
                                    </MudGrid>
                                </MudItem>

                            </MudGrid>
                        }
                        else if (NumAba == 2)
                        {
                            <MudGrid>
                                <MudItem xs="12">
                                    <MudPaper Class="d-flex align-center justify-center mud-width-full py-8">Aba de tributações</MudPaper>
                                </MudItem>
                            </MudGrid>
                        }
                        else if (NumAba == 3)
                        {
                            <MudGrid>
                                <MudItem xs="12">
                                    <MudPaper Class="d-flex align-center justify-center mud-width-full py-8">Aba de ficha técnica</MudPaper>
                                </MudItem>
                            </MudGrid>
                        }
                    </MudCardContent>
                </MudCard>
            </ChildRowContent>

        </MudDataGrid>
    </MudLayout>
</MudPaper>


<MudOverlay @bind-Visible="Aviso" LockScroll="false" DarkBackground="false" AutoClose="true" />
@code {
    List<ClsProduto> Produtos = new();
    private string StringDePesquisa = string.Empty;
    ClsProduto? ExpandedProduto;
    private bool _enableHeaderToggle = true;
    private int NumAba = 1;
    private List<ClsGrupo> Grupos = new();
    private bool Aviso = false;
    public CultureInfo _pt = CultureInfo.GetCultureInfo("pt-BR");


    async void ToggleExpand(ClsProduto item)
    {
        if (ExpandedProduto == item)
            ExpandedProduto = null;
        else
            ExpandedProduto = item;

    }

    protected override async Task OnInitializedAsync()
    {
        await AtualizaGrupos();
        await AtualizaProdutos();

    }

    private async Task AtualizaProdutos(bool ProdutoFoiModificado = false)
    {
        Produtos = await ProdutoService.GetProdutosAsync();
    }

    private async Task AtualizaGrupos(bool ProdutoFoiModificado = false)
    {
        Grupos = await GrupoService.GetGrupos();
    }

    private async Task RecarregarProdutosAposPesquisa()
    {
        if (!string.IsNullOrEmpty(StringDePesquisa))
        {
            Produtos = Produtos.FindAll(x => x.CodigoInterno!.Contains(StringDePesquisa) || x.Descricao!.Contains(StringDePesquisa, StringComparison.OrdinalIgnoreCase));
        }
        else
        {
            await AtualizaProdutos();
        }
    }

    private async Task TrocaAbaDeInfosDoProduto(int numAba = 1)
    {
        NumAba = numAba;
    }

    private async Task OnSaveChanges(ClsProduto produtoModificado)
    {
        produtoModificado.ImpressoraComanda1 = TraduzImpressora(produtoModificado.ImpressoraComanda1!);
        produtoModificado.ImpressoraComanda2 = TraduzImpressora(produtoModificado.ImpressoraComanda2!);
        var response = await ProdutoService.EditaProduto(produtoModificado);
        var responseAsString = await response.Content.ReadAsStringAsync();

        if (!response.IsSuccessStatusCode)
        {
            Snackbar.Add($"{responseAsString}", Severity.Error);
        }
        else
        {
            Snackbar.Add($"Produto {produtoModificado.Descricao} alterado com sucesso!", Severity.Success);
        }

        StateHasChanged();
    }

    private async Task OnTamanhoUnicoSelected(bool NovoValor)
    {

    }

    private string TraduzImpressora(string CodImpressora)
    {
        switch (CodImpressora)
        {
            case "Caixa":
                return "Cai";
            case "Cozinha 1":
                return "Cz1";
            case "Cozinha 2":
                return "Cz2";
            case "Cozinha 3":
                return "Cz3";
            case "Bar":
                return "Bar";
            case "Não":
                return "Nao";
            default:
                return CodImpressora;
        }

    }

    private async Task AtualizaValorDoProduto(Preco preco)
    {
        var response = await ProdutoService.EditaPrecoDoProduto(preco);
        var responseAsString = await response.Content.ReadAsStringAsync();

        if (!response.IsSuccessStatusCode)
        {
            Snackbar.Add($"{preco.Valor}", Severity.Error);
        }
        else
        {
            Snackbar.Add($"valor {preco.Valor} alterado com sucesso!", Severity.Success);
        }

        StateHasChanged();
    }

    //----------------------------------------------------------------------- Definir impressoras

    private string _value;
    private Margin _margin;
    private bool _dense;
    private bool _disabled;
    private bool _readonly;
    private bool _placeholder;
    private bool _helperText;
    private bool _helperTextOnFocus;
    private bool _clearable;
    private bool _fitContent;
    private bool _modal = true;

    private readonly string[] _states =
    {
        "Cz1","Cz2","Cz3","Bar","Cai","Nao"
    };
}
