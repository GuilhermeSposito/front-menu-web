@rendermode RenderMode.InteractiveWebAssembly
@attribute [Authorize]
@page "/gestao-de-pedidos"
@using FrontMenuWeb.Components.Modais.ModaisDeGrupo
@using FrontMenuWeb.Components.Modais.ModaisDeProdutos
@using FrontMenuWeb.Components.Modais.ModaisDeProdutos.Complementos
@using FrontMenuWeb.Components.Modais.ModaisDeProdutos.GrupoDeComplementosNosProdutos
@using FrontMenuWeb.Components.Modais.ModaisDeVendas
@using FrontMenuWeb.Models.Pedidos
@using FrontMenuWeb.Services
@using Microsoft.AspNetCore.Components
@using System.Globalization;
@using MudBlazor.Extensions
@using MudBlazor.Extensions.Components
@inject GrupoServices GrupoService
@inject ISnackbar Snackbar
@inject IHttpClientFactory HttpClientFactory
@inject ProdutoService ProdutoService
@inject AliquotaService AliquotaService
@inject ComplementosServices ComplementosServices
@inject PedidosService PedidosService

<MudPaper Square="false" Elevation="0" Style="background-color: var(--mud-palette-background); min-height: 100vh">
    <MudLayout>
        <MudStack Class="w-100 mb-2 p-3 rounded-2" AlignItems="AlignItems.Start" Justify="Justify.Center" Style="background-color: var(--mud-palette-surface)">
            <MudText Typo="Typo.h4" Style="font-weight: 300">Últimos pedidos</MudText>
            <MudDivider DividerType="DividerType.FullWidth" Light=true />
        </MudStack>
        <MudStack Class="w-100 p-3 rounded-2" Row="true" AlignItems="AlignItems.Center" Justify="Justify.FlexStart" Style="background-color: var(--mud-palette-surface)">
            <MudStack Class="w-50" Row=true>
                <MudTextField Class="w-100 mt-2 rounded-2" Label="Pesquisa" Adornment="Adornment.Start" PlaceHolder="Pesquise por nome de cliente, número ou pedido" Variant="Variant.Filled" T="string" AdornmentIcon="@Icons.Material.Filled.Search" AdornmentColor=Color.Primary Immediate=true></MudTextField>
            </MudStack>
            <MudStack Justify="Justify.FlexStart">
                <MudButton StartIcon="@Icons.Material.Filled.AddBox" Variant="Variant.Filled" Color="Color.Primary" Disabled="false" OnClick="@(async () => { await AbrirCriacaoDePedido(); })">Novo Pedido</MudButton>
            </MudStack>
        </MudStack>

        @if (!Carregando)
        {
            <MudStack Class="w-100" AlignItems="AlignItems.Center" Justify="Justify.Center">
                <MudGrid Class="w-100 mt-2">
                    @foreach (var etapa in ListaDeEtapasDosPedidos)
                    {
                        <MudItem xs="12" md="6" xl="3">
                            <MudCard Style="min-height: 520px">
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <MudText>@etapa.NomeDaEtapa</MudText>
                                    </CardHeaderContent>
                                    <CardHeaderActions>
                                        <MudCheckBox T="bool" />
                                    </CardHeaderActions>
                                </MudCardHeader>
                                <MudCardContent>
                                    @{
                                        var Pedidos = _items.Where(p => p.Selector == etapa.Selector).ToList();
                                        if (Pedidos.Count > 0)
                                        {
                                            foreach (var pedido in Pedidos)
                                            {
                                                <MudCard Class="rouded-2 mb-3" Style="background-color: var(--mud-palette-background)">
                                                    <MudCardHeader>
                                                        <CardHeaderAvatar>
                                                            <MudAvatar Color="Color.Primary">
                                                                @if (pedido.Pedido.CriadoPor == "SOPHOS")
                                                                {
                                                                    <MudImage Src="/images/SOPHOSLOGOLOGIN.jpg"></MudImage>
                                                                }
                                                                else if (pedido.Pedido.CriadoPor == "IFOOD")
                                                                {
                                                                    <MudImage Src="/images/ifoodImagem.png"></MudImage>
                                                                }
                                                            </MudAvatar>
                                                        </CardHeaderAvatar>
                                                        <CardHeaderContent>
                                                            <MudText Color="Color.Primary" Typo="Typo.body1">@pedido.Pedido.CriadoPor - @pedido.Pedido.TipoDePedido</MudText>
                                                            @if (pedido.Pedido.Cliente is not null)
                                                            {
                                                                <MudText Color="Color.Default" Typo="Typo.caption">@pedido.Pedido.Cliente.Nome</MudText>
                                                            }
                                                            <MudText>@pedido.Pedido.CriadoEm</MudText>
                                                        </CardHeaderContent>
                                                        <CardHeaderActions>
                                                            @if (!pedido.UltimaEtapa)
                                                            {
                                                                <MudCheckBox ValueChanged=@(() => { pedido.Selecionado = !pedido.Selecionado; if (pedido.Selecionado) { ItensSelecionadosPArAProximaEtapa.Add(pedido); } else { ItensSelecionadosPArAProximaEtapa.Remove(pedido); } }) T="bool" Value=@pedido.Selecionado />
                                                            }
                                                        </CardHeaderActions>
                                                    </MudCardHeader>
                                                    <MudCardContent>
                                                        @foreach (var item in pedido.Pedido.Itens)
                                                        {
                                                            <MudStack Class="w-100" Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                <MudText>@($"{item.Quantidade}X {item.Descricao}")</MudText>
                                                                <MudText>@($"{item.PrecoUnitario.ToString("C")}")</MudText>
                                                            </MudStack>
                                                            <MudDivider DividerType="DividerType.FullWidth" Light=true />
                                                            if (item.Complementos.Count > 0)
                                                            {
                                                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.Center">
                                                                    <MudText Align="Align.Center" Typo="Typo.caption">Complementos:</MudText>
                                                                </MudStack>
                                                                foreach (var complemento in item.Complementos)
                                                                {
                                                                    <MudStack Row="true" Justify="Justify.FlexEnd" AlignItems="AlignItems.End">
                                                                        <MudText Typo="Typo.caption">@($"{complemento.Quantidade}X {complemento.Descricao} - {complemento.PrecoUnitario.ToString("C")}")</MudText>
                                                                    </MudStack>
                                                                }
                                                                <MudDivider DividerType="DividerType.FullWidth" Light=true />
                                                            }

                                                            <MudStack Style="color:  var(--mud-palette-primary)" AlignItems="AlignItems.Center">
                                                                <MudStack Spacing="2" Class="w-100">
                                                                    <MudButton OnClick="@(() => { OnExpandCollapseClick(pedido); })" StartIcon="@Icons.Material.Filled.ArrowDropDown">@(!@pedido.Expandido ? "Ver infos de pags" : "Esconder infos de pag")</MudButton>
                                                                    <MudDivider />
                                                                    <MudCollapse Expanded="@pedido.Expandido">
                                                                        <MudStack Class="w-100">
                                                                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                                <MudText Typo="Typo.subtitle2">Subtotal:</MudText>
                                                                                <MudText Typo="Typo.subtitle2">@(0.ToString("C"))</MudText>
                                                                            </MudStack>
                                                                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                                <MudText Typo="Typo.subtitle2">Desconto:</MudText>
                                                                                <MudText Typo="Typo.subtitle2">@(0.ToString("C"))</MudText>
                                                                            </MudStack>
                                                                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                                <MudText Typo="Typo.subtitle2">Acrescimo:</MudText>
                                                                                <MudText Typo="Typo.subtitle2">@(0.ToString("C"))</MudText>
                                                                            </MudStack>
                                                                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                                <MudText Typo="Typo.subtitle2">Taxa de entrega:</MudText>
                                                                                <MudText Typo="Typo.subtitle2">@(0.ToString("C"))</MudText>
                                                                            </MudStack>
                                                                            <MudDivider />
                                                                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                                <MudText Typo="Typo.h6" Style="font-weight: 600">Total:</MudText>
                                                                                <MudText Typo="Typo.h6" Style="font-weight: 600">@(0.ToString("C"))</MudText>
                                                                            </MudStack>
                                                                        </MudStack>
                                                                    </MudCollapse>
                                                                </MudStack>
                                                            </MudStack>
                                                        }
                                                    </MudCardContent>
                                                    <MudCardActions>
                                                        <MudStack Class="w-100" Row=true AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                            <MudStack Row=true>
                                                                <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                                                                    <MudMenuItem Icon="@Icons.Material.Filled.Print" Label="Imprimir" />
                                                                    <MudMenuItem Icon="@Icons.Material.Filled.ReceiptLong" Label="Cupom Fiscal" />
                                                                    <MudMenuItem Icon="@Icons.Material.Filled.LocalShipping" Label="Enviar Para Entrega" />
                                                                    <MudMenuItem Icon="@Icons.Material.Filled.Edit" Label="Editar" />
                                                                    <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error" Label="Cancelar" />
                                                                </MudMenu>
                                                            </MudStack>
                                                            <MudStack>
                                                                <MudTooltip Color="Color.Primary" Text="Clique para enviar pedido para proxima etapa!">
                                                                    @if (!pedido.UltimaEtapa)
                                                                    {
                                                                        <MudIconButton OnClick="@(async () => { await MudaEtapaDoPedido(pedido); })" Size="Size.Large" Icon="@Icons.Material.Filled.ArrowCircleRight" Color="Color.Primary" />

                                                                    }
                                                                </MudTooltip>
                                                            </MudStack>
                                                        </MudStack>
                                                    </MudCardActions>
                                                </MudCard>
                                            }
                                        }
                                        else
                                        {
                                            <MudStack AlignItems="AlignItems.Center"
                                                      Justify="Justify.Center"
                                                      Style="width: 100%; height: 100%; opacity: 0.4;">
                                                <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="Size.Large" Class="mb-2" />
                                                <MudText Typo="Typo.subtitle1" Align="Align.Center">
                                                    Nenhum pedido nesta etapa
                                                </MudText>
                                                <MudText Typo="Typo.caption" Align="Align.Center">
                                                    Seus pedidos aparecerão aqui quando estiverem nessa etapa.
                                                </MudText>
                                            </MudStack>
                                        }
                                    }
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            </MudStack>
        }
        else
        {
            @*Carregando*@
            <MudStack Class="w-100 rounded-2 mt-2 h-100" Style="background-color: var(--mud-palette-surface); min-height: 520px" AlignItems="AlignItems.Center" Justify="Justify.Center">
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
            </MudStack>
        }

        @if (ItensSelecionadosPArAProximaEtapa.Count > 0)
        {
            <MudPaper Class="d-flex flex-wrap gap-2 justify-content-center align-items-center px-4 py-2"
                      Style="color: #FFFF; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 1300; background-color: var(--mud-palette-primary); box-shadow: 0 -2px 5px rgba(0,0,0,0.1);">
                <MudText>Você selecionou @ItensSelecionadosPArAProximaEtapa.Count pedidos, deseja envia-los para proxima etapa ?</MudText>

                <MudPaper Elevation="0" Style=" background-color: var(--mud-palette-primary);" Square="false">

                    <MudButton Style="color: #FFFF;" OnClick="@(async () => { ItensSelecionadosPArAProximaEtapa.Clear(); })">Descartar</MudButton>
                    <MudButton Style="color: #FFFF;" OnClick="@(async () => { await MudaEtapaDoPedido(); })" Class="ml-2">Enviar para proxima etapa</MudButton>

                </MudPaper>
            </MudPaper>
        }

    </MudLayout>
</MudPaper>

@code {
    public bool Carregando { get; set; } = true;
    private List<ClsDeSuporteParaMostrarPedidos> _items = new List<ClsDeSuporteParaMostrarPedidos>();
    public List<ClsDeSuporteParaVizualicacaoDePedidos> ListaDeEtapasDosPedidos = new List<ClsDeSuporteParaVizualicacaoDePedidos>
    {
        new ClsDeSuporteParaVizualicacaoDePedidos { NomeDaEtapa = "NOVOS", Selector = "NOVO" },
        new ClsDeSuporteParaVizualicacaoDePedidos { NomeDaEtapa = "PREPARANDO", Selector = "PREPARANDO" },
        new ClsDeSuporteParaVizualicacaoDePedidos { NomeDaEtapa = "DESPACHADOS / PRONTOS", Selector = "DESPACHADO" },
        new ClsDeSuporteParaVizualicacaoDePedidos { NomeDaEtapa = "FINALIZADOS", Selector = "FINALIZADO" },
    };
    public List<ClsDeSuporteParaMostrarPedidos> ItensSelecionadosPArAProximaEtapa = new List<ClsDeSuporteParaMostrarPedidos>();


    private async Task AbrirCriacaoDePedido()
    {
        var options = new DialogOptions {MaxWidth = MaxWidth.False, FullWidth = false,FullScreen = false, CloseOnEscapeKey = false, BackdropClick= false };

        var dialog = await DialogService.ShowAsync<ModalDeCriarPedido>("Cadastrar Pedido", options);
        var result = await dialog.Result;

        if (!result!.Canceled && result.Data is bool sucesso && sucesso)
        {
            await InvokeAsync(StateHasChanged);
        }
    }


    protected override async Task OnInitializedAsync()
    {
        await CarregarPedidos();
    }

    private void OnExpandCollapseClick(ClsDeSuporteParaMostrarPedidos sup)
    {
        sup.Expandido = !sup.Expandido;
    }

    public async Task CarregarPedidos()
    {
        try
        {
            var result = await PedidosService.GetPedidosPorPaginaAsync(new QuerysDePedidos());

            if (result?.Data?.Any() == true)
            {
                _items = result.Data.Select(p => new ClsDeSuporteParaMostrarPedidos
                {
                    Pedido = p,
                    Selector = p.EtapaPedido
                }).ToList();
            }
            else
            {
                Snackbar.Add("Nenhum pedido encontrado.", Severity.Warning);
            }
        }
        catch (Exception)
        {
            Snackbar.Add("Nenhum pedido encontrado.", Severity.Warning);
        }
        finally
        {
            Carregando = false;
            await InvokeAsync(StateHasChanged);
        }
    }


    private async Task MudaEtapaDoPedido(ClsDeSuporteParaMostrarPedidos? Supor = null)
    {
        if (Supor is not null)
        {
            Snackbar.Add($"Pedido atualizado com sucesso!", Severity.Success);

            if (Supor.Selector == "NOVO")
            {
                Supor.Selector = "PREPARANDO";
                await InvokeAsync(StateHasChanged);
                return;
            }

            if (Supor.Selector == "PREPARANDO")
            {
                Supor.Selector = "DESPACHADO"; // Exemplo de mudança de etapa
                await InvokeAsync(StateHasChanged);
                return;
            }

            if (Supor.Selector == "DESPACHADO")
            {
                Supor.Selector = "FINALIZADO";
                Supor.UltimaEtapa = true;
                await InvokeAsync(StateHasChanged);
                return;
            }
        }
        else if (ItensSelecionadosPArAProximaEtapa.Count > 0)
        {
            foreach (var item in ItensSelecionadosPArAProximaEtapa)
            {
                if (item.Selector == "NOVO")
                {
                    item.Selector = "PREPARANDO";
                    item.Selecionado = false;
                    await InvokeAsync(StateHasChanged);
                    continue;
                }

                if (item.Selector == "PREPARANDO")
                {
                    item.Selector = "DESPACHADO"; // Exemplo de mudança de etapa
                    item.Selecionado = false;
                    await InvokeAsync(StateHasChanged);
                    continue;
                }

                if (item.Selector == "DESPACHADO")
                {
                    item.Selector = "FINALIZADO";
                    item.UltimaEtapa = true;
                    item.Selecionado = false;
                    await InvokeAsync(StateHasChanged);
                    continue;
                }
            }

            ItensSelecionadosPArAProximaEtapa.Clear();
            await InvokeAsync(StateHasChanged);
        }

    }




   

    public class ClsDeSuporteParaVizualicacaoDePedidos
    {
        public string NomeDaEtapa = string.Empty;
        public string Selector { get; set; } = "1";
    }


}
