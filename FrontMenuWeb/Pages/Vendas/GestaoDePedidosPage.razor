@rendermode RenderMode.InteractiveWebAssembly
@attribute [Authorize]
@page "/gestao-de-pedidos"
@inject IJSRuntime JS
@using FrontMenuWeb.Components.Modais.ModaisDeGrupo
@using FrontMenuWeb.Components.Modais.ModaisDeProdutos
@using FrontMenuWeb.Components.Modais.ModaisDeProdutos.Complementos
@using FrontMenuWeb.Components.Modais.ModaisDeProdutos.GrupoDeComplementosNosProdutos
@using FrontMenuWeb.Components.Modais.ModaisDeVendas
@using FrontMenuWeb.Components.Modais.ModalFiscais
@using FrontMenuWeb.Dtos
@using FrontMenuWeb.Models.Financeiro
@using FrontMenuWeb.Models.Merchant
@using FrontMenuWeb.Models.Pedidos
@using FrontMenuWeb.Services
@using FrontMenuWeb.Services.Fiscal
@using Microsoft.AspNetCore.Components
@using System.Globalization;
@using MudBlazor.Extensions
@using MudBlazor.Extensions.Components
@inject GrupoServices GrupoService
@inject CaixaEPagamentosService CaixasService
@inject ISnackbar Snackbar
@inject IHttpClientFactory HttpClientFactory
@inject ProdutoService ProdutoService
@inject AliquotaService AliquotaService
@inject ComplementosServices ComplementosServices
@inject PedidosService PedidosService
@inject NfService NFService

<MudPaper tabindex="0" @onkeydown=HandleKeyDownGestaoPedidos Square="false" Elevation="0" class="@((CarregandoParteFiscal ? "wait-cursor gestao-pedido-page" : "gestao-pedido-page"))" Style="background-color: var(--mud-palette-background); min-height: 100vh">
    <MudLayout>
        <MudFocusTrap DefaultFocus="DefaultFocus.FirstChild">
            <MudStack Class="w-100 p-3 rounded-2" Row="true" AlignItems="AlignItems.Center" Justify="Justify.FlexStart" Style="background-color: var(--mud-palette-surface)">
                <MudStack Class="w-50" Row=true>
                    <MudTextField DebounceInterval="1300" Value="pesquisaTexto" ValueChanged="OnPesquisaChanged" Class="w-100 mt-2 rounded-2" Label="Pesquisa" Adornment="Adornment.Start" PlaceHolder="Pesquise por nome de cliente, número ou pedido" Variant="Variant.Filled" T="string" AdornmentIcon="@Icons.Material.Filled.Search" AdornmentColor=Color.Primary Immediate=false></MudTextField>
                </MudStack>
                <MudStack Class="m-2" AlignItems="AlignItems.Center" Justify="Justify.Center">
                    <MudSelect Label="Tipo De Pedidos" ValueChanged=OnFiltroChanged Value="FiltroPorTipoDePedido" T="TiposDePedido" Variant="Variant.Filled" AdornmentColor="Color.Primary">
                        <MudSelectItem Value="@TiposDePedido.TODOS">Todos</MudSelectItem>
                        <MudSelectItem Value=@TiposDePedido.BALCÃO>Balcão</MudSelectItem>
                        <MudSelectItem Value=@TiposDePedido.DELIVERY>Delivery</MudSelectItem>
                        <MudSelectItem Value=@TiposDePedido.MESA>Mesa</MudSelectItem>
                    </MudSelect>
                </MudStack>
                <MudStack Row=true Justify="Justify.FlexStart">

                    <MudTooltip Text="Abre Criação de novo Pedido" Color="Color.Primary">
                        <MudButton StartIcon="@Icons.Material.Filled.AddBox" Variant="Variant.Filled" Color="Color.Primary" Disabled="false" OnClick="@(async () => { await AbrirCriacaoDePedido(); })">Novo Pedido (F1 / F2 / F3)</MudButton>
                    </MudTooltip>
                    @if (AppState.MerchantLogado.UsaCodigoDeBarrasParAProximaEtapa)
                    {
                        <MudTooltip Text="Abre Leitor de código de barras para enviar pedido para proxima etapa" Color="Color.Primary">
                            <MudIconButton Icon="@Icons.Material.Filled.ReceiptLong" Variant="Variant.Filled" Color="Color.Primary" Disabled="false" OnClick="@(async () => { await AbreModalDeCodigoDeBarrasParaProximaEtapa(); })"></MudIconButton>
                        </MudTooltip>
                    }
                </MudStack>
            </MudStack>
            @if (PedidosEmAberto.Any())
            {
                <MudStack Class="w-100 p-3 rounded-2 mt-1" AlignItems="AlignItems.Center" Justify="Justify.FlexStart" Style="background-color: var(--mud-palette-surface)">
                    <MudText>Pedidos Abertos</MudText>
                    <MudStack Row=true AlignItems="AlignItems.Center" Justify="Justify.Center">
                        @{
                            int ReferenciaDoPedido = 1;
                            foreach (var pedido in PedidosEmAberto)
                            {
                                var referenciaAtual = ReferenciaDoPedido;
                                <MudChip Value=@pedido OnClose="Closed" OnClick="@(async () => { await AbrirCriacaoDePedido(PedidoAberto: pedido); })" T="ClsPedido" Color="Color.Error" Variant="Variant.Filled" Class="m-1 p-2">Pedido @referenciaAtual</MudChip>
                                ReferenciaDoPedido++;
                            }
                        }
                    </MudStack>
                </MudStack>
            }

            @if (CarregandoParteFiscal)
            {
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.subtitle1">Emitindo NFC-e...</MudText>
                    <MudProgressLinear Value="ProgressoFiscal" Color="Color.Primary" />
                    <MudText Typo="Typo.caption">@ProgressoFiscal%</MudText>
                </MudPaper>
            }

            @if (!Carregando)
            {
                <MudStack Class="w-100" AlignItems="AlignItems.Center" Justify="Justify.Center">
                    <MudGrid Class="w-100 mt-2">
                        @foreach (var etapa in ListaDeEtapasDosPedidos)
                        {
                            <MudItem xs="12" md="4" xl="4">
                                <MudCard Class="h-100 ma-1 rounded-3"
                                         Style="min-height: 520px; max-height: 900px;">
                                    <MudCardHeader Style="background-color: var(--mud-palette-primary); color: white;">
                                        <CardHeaderContent>
                                            <MudText>@etapa.NomeDaEtapa</MudText>
                                        </CardHeaderContent>
                                        <CardHeaderActions>
                                            <MudCheckBox T="bool" Disabled=@(etapa.Selector == "FINALIZADO") ValueChanged=@(() => { SelecionaPedidosParaProximaEtapaNoCabecalho(etapa); }) />
                                        </CardHeaderActions>
                                    </MudCardHeader>
                                    <MudCardContent Style="overflow-y: auto; scroll-behavior: smooth; border: 2px solid var(--mud-palette-primary); ">
                                        @{
                                            var Pedidos = _items.Where(p => p.Selector == etapa.Selector).ToList();
                                            if (Pedidos.Count > 0)
                                            {
                                                foreach (var pedido in Pedidos)
                                                {
                                                    <MudCard Class="rounded-3 mb-3" Style=@($"background-color: {(pedido.Pedido.StatusPedido == "CANCELADO" ? "var(--mud-palette-error);" : "var(--mud-palette-background)")}; border: 2px dashed {(pedido.Pedido.StatusPedido == "FECHADO" ? "var(--mud-palette-primary)" : "var(--mud-palette-error)")};")>
                                                        <MudCardHeader>
                                                            <CardHeaderAvatar>
                                                                <MudAvatar Color="Color.Primary">
                                                                    @if (pedido.Pedido.CriadoPor == "SOPHOS")
                                                                    {
                                                                        <MudImage Src="/images/SOPHOSLOGOLOGIN.jpg"></MudImage>
                                                                    }
                                                                    else if (pedido.Pedido.CriadoPor == "IFOOD")
                                                                    {
                                                                        <MudImage Src="/images/ifoodImagem.png"></MudImage>
                                                                    }
                                                                </MudAvatar>
                                                            </CardHeaderAvatar>
                                                            <CardHeaderContent>
                                                                <MudText Color="Color.Primary" Typo="Typo.body1">
                                                                    @pedido.Pedido.CriadoPor - @pedido.Pedido.TipoDePedido - @pedido.Pedido.DisplayId - @pedido.Pedido.Id @if(pedido.Pedido.StatusPedido == "CANCELADO"){
                                                                    @(" - Cancelado")
                                                                }
                                                            </MudText>
                                                            @if (pedido.Pedido.Cliente is not null)
                                                            {
                                                                <MudText Color="Color.Default" Typo="Typo.caption">@pedido.Pedido.Cliente.Nome</MudText>
                                                            }
                                                            <MudText>@pedido.Pedido.CriadoEm</MudText>
                                                        </CardHeaderContent>
                                                        <CardHeaderActions>
                                                            @if (!pedido.UltimaEtapa)
                                                            {
                                                                <MudCheckBox ValueChanged=@(() => { pedido.Selecionado = !pedido.Selecionado; if (pedido.Selecionado) { ItensSelecionadosPArAProximaEtapa.Add(pedido); } else { ItensSelecionadosPArAProximaEtapa.Remove(pedido); } }) T="bool" Value=@pedido.Selecionado />
                                                            }
                                                        </CardHeaderActions>
                                                    </MudCardHeader>
                                                    <MudCardContent>
                                                        @foreach (var item in pedido.Pedido.Itens)
                                                        {
                                                            <MudStack Class="p-2 mt-1 rounded-2" Style=@($"background-color: {(pedido.Pedido.StatusPedido == "CANCELADO" ? "var(--mud-palette-error);" : "var(--mud-palette-background)")}; border: 2px dashed {(pedido.Pedido.StatusPedido == "FECHADO" ? "var(--mud-palette-primary)" : "var(--mud-palette-error)")};")>
                                                                <MudStack Class="w-100" Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                    <MudText>@($"{item.Quantidade}X {item.Descricao}")</MudText>
                                                                    <MudText>Valor Unitario: @($"{item.PrecoUnitario.ToString("C")}")</MudText>
                                                                </MudStack>
                                                                <MudDivider DividerType="DividerType.FullWidth" Light=true />
                                                                <MudStack Class="w-100" Row="true" AlignItems="AlignItems.Center" Justify="Justify.FlexEnd">
                                                                    <MudText>Valor Total: @($"{item.PrecoTotal.ToString("C")}")</MudText>
                                                                </MudStack>
                                                                @if (item.Complementos.Count > 0)
                                                                {
                                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.Center">
                                                                        <MudText Align="Align.Center" Typo="Typo.caption">Complementos:</MudText>
                                                                    </MudStack>
                                                                    foreach (var complemento in item.Complementos)
                                                                    {
                                                                        <MudStack Row="true" Justify="Justify.FlexStart" AlignItems="AlignItems.End">
                                                                            <MudText Typo="Typo.caption">@($"{complemento.Quantidade}X {complemento.Descricao} - {complemento.PrecoUnitario.ToString("C")}")</MudText>
                                                                        </MudStack>
                                                                    }
                                                                    <MudDivider DividerType="DividerType.FullWidth" Light=true />
                                                                }
                                                            </MudStack>
                                                        }
                                                        <MudStack Style="color:  var(--mud-palette-primary)" AlignItems="AlignItems.Center">
                                                            <MudStack Spacing="2" Class="w-100">
                                                                <MudButton OnClick="@(() => { OnExpandCollapseClick(pedido); })" StartIcon="@Icons.Material.Filled.ArrowDropDown">@(!@pedido.Expandido ? "Ver infos de pags" : "Esconder infos de pag")</MudButton>
                                                                <MudDivider />
                                                                <MudCollapse Expanded="@pedido.Expandido">
                                                                    <MudStack Class="w-100">
                                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                            <MudText Typo="Typo.subtitle2">Subtotal:</MudText>
                                                                            <MudText Typo="Typo.subtitle2">@pedido.Pedido.ValorDosItens.ToString("C")</MudText>
                                                                        </MudStack>

                                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                            <MudText Typo="Typo.subtitle2">Desconto:</MudText>
                                                                            <MudText Typo="Typo.subtitle2">@pedido.Pedido.DescontoValor.ToString("C")</MudText>
                                                                        </MudStack>

                                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                            <MudText Typo="Typo.subtitle2">Acréscimo:</MudText>
                                                                            <MudText Typo="Typo.subtitle2">@((pedido.Pedido.AcrescimoValor + pedido.Pedido.ServicoValor).ToString("C"))</MudText>
                                                                        </MudStack>

                                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                            <MudText Typo="Typo.subtitle2">Incentivos:</MudText>
                                                                            <MudText Typo="Typo.subtitle2">@pedido.Pedido.IncentivosExternosValor.ToString("C")</MudText>
                                                                        </MudStack>

                                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                            <MudText Typo="Typo.subtitle2">Taxa Entrega:</MudText>
                                                                            <MudText Typo="Typo.subtitle2">@pedido.Pedido.TaxaEntregaValor.ToString("C")</MudText>
                                                                        </MudStack>

                                                                        <MudDivider />

                                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                            <MudText Typo="Typo.h6" Style="font-weight: 600">Total:</MudText>
                                                                            <MudText Typo="Typo.h6" Style="font-weight: 600">@pedido.Pedido.ValorTotal.ToString("C")</MudText>
                                                                        </MudStack>

                                                                    </MudStack>
                                                                </MudCollapse>
                                                            </MudStack>
                                                        </MudStack>
                                                    </MudCardContent>
                                                    <MudCardActions>
                                                        <MudStack Class="w-100" Row=true AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                            <MudStack Row=true>
                                                                <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                                                                    <MudMenuItem OnClick=@(async () => { await ImprimirPedido(pedido.Pedido); }) Icon="@Icons.Material.Filled.Print" Label="Imprimir" />
                                                                    <MudMenuItem OnClick=@(async () => { await EmiteNFCe(pedido.Pedido); }) Icon="@Icons.Material.Filled.ReceiptLong" Label="Cupom Fiscal" />
                                                                    <MudMenuItem Icon="@Icons.Material.Filled.LocalShipping" Label="Enviar Para Entrega" />
                                                                    @if (pedido.Pedido.StatusPedido != "FECHADO")
                                                                    {
                                                                        <MudMenuItem Icon="@Icons.Material.Filled.AttachMoney" Label="Fechar Pagamento" />
                                                                    }
                                                                    @if (pedido.Pedido.StatusPedido != "CANCELADO")
                                                                    {
                                                                        <MudMenuItem OnClick="@(async () => { await EditarPedido(pedido.Pedido); })" Icon="@Icons.Material.Filled.Edit" Label="Editar Pagamento" />
                                                                        <MudMenuItem OnClick=@(async () => { await CancelarPedido(pedido.Pedido); }) Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error" Label="Cancelar" />
                                                                    }
                                                                </MudMenu>
                                                            </MudStack>
                                                            <MudStack Row=true>
                                                                @if (pedido.Pedido.EtapaPedido == "DESPACHADO")
                                                                {
                                                                    <MudTooltip Color="Color.Primary" Text="Clique para Avisar Novamente">
                                                                        <MudIconButton OnClick="@(async () => { await AvisarNovamenteMesmoPedido(pedido.Pedido); })" Size="Size.Large" Icon="@Icons.Material.Filled.RemoveRedEye" Color="Color.Primary" />
                                                                    </MudTooltip>
                                                                }
                                                                <MudTooltip Color="Color.Primary" Text="Clique para enviar pedido para proxima etapa!">
                                                                    @if (!pedido.UltimaEtapa)
                                                                    {
                                                                        <MudIconButton OnClick="@(async () => { await MudaEtapaDoPedido(pedido); })" Size="Size.Large" Icon="@Icons.Material.Filled.ArrowCircleRight" Color="Color.Primary" />
                                                                    }
                                                                </MudTooltip>
                                                            </MudStack>
                                                        </MudStack>
                                                    </MudCardActions>
                                                </MudCard>
                                            }
                                        }
                                                                else
                                        {
                                            <MudStack AlignItems="AlignItems.Center"
                                                      Justify="Justify.Center"
                                                      Style="width: 100%; height: 100%; opacity: 0.4;">
                                                <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="Size.Large" Class="mb-2" />
                                                <MudText Typo="Typo.subtitle1" Align="Align.Center">
                                                    Nenhum pedido nesta etapa
                                                </MudText>
                                                <MudText Typo="Typo.caption" Align="Align.Center">
                                                    Seus pedidos aparecerão aqui quando estiverem nessa etapa.
                                                </MudText>
                                            </MudStack>
                                        }
                                    }
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            </MudStack>
                        }
                        else
            {
                @*Carregando*@
                <MudStack Class="w-100 rounded-2 mt-2 h-100" Style="background-color: var(--mud-palette-surface); min-height: 520px" AlignItems="AlignItems.Center" Justify="Justify.Center">
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="w-50 my-7" />
                </MudStack>
            }

            @if (ItensSelecionadosPArAProximaEtapa.Count > 0)
            {
                <MudPaper Class="d-flex flex-wrap gap-2 justify-content-center align-items-center px-4 py-2"
                          Style="color: #FFFF; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 1300; background-color: var(--mud-palette-primary); box-shadow: 0 -2px 5px rgba(0,0,0,0.1);">
                    <MudText>Você selecionou @ItensSelecionadosPArAProximaEtapa.Count pedidos, deseja envia-los para proxima etapa ?</MudText>

                    <MudPaper Elevation="0" Style=" background-color: var(--mud-palette-primary);" Square="false">

                        <MudButton Style="color: #FFFF;" OnClick="@(async () => { ItensSelecionadosPArAProximaEtapa.Clear(); })">Descartar</MudButton>
                        <MudButton Style="color: #FFFF;" OnClick="@(async () => { await MudaEtapaDoPedido(); })" Class="ml-2">Enviar para proxima etapa</MudButton>

                    </MudPaper>
                </MudPaper>
            }
        </MudFocusTrap>
    </MudLayout>
</MudPaper>

@code {
    #region Propriedades
    public bool Carregando { get; set; } = true;
    public bool CarregandoParteFiscal { get; set; } = false;
    private List<ClsDeSuporteParaMostrarPedidos> _items = new List<ClsDeSuporteParaMostrarPedidos>();
    public List<ClsDeSuporteParaVizualicacaoDePedidos> ListaDeEtapasDosPedidos = new List<ClsDeSuporteParaVizualicacaoDePedidos>
    {
        //new ClsDeSuporteParaVizualicacaoDePedidos { NomeDaEtapa = "NOVOS", Selector = "NOVO" },
        new ClsDeSuporteParaVizualicacaoDePedidos { NomeDaEtapa = "PREPARANDO", Selector = "PREPARANDO" },
        new ClsDeSuporteParaVizualicacaoDePedidos { NomeDaEtapa = "DESPACHADOS / PRONTOS", Selector = "DESPACHADO" },
        new ClsDeSuporteParaVizualicacaoDePedidos { NomeDaEtapa = "FINALIZADOS", Selector = "FINALIZADO" },
    };
    public List<ClsDeSuporteParaMostrarPedidos> ItensSelecionadosPArAProximaEtapa = new List<ClsDeSuporteParaMostrarPedidos>();

    private string status = "Desconectado";

    private MudTextField<string> pesquisaField;
    private string pesquisaTexto = string.Empty;
    private TiposDePedido FiltroPorTipoDePedido = TiposDePedido.TODOS;

    //Propriedade Para Manter pedidos em aberto
    private List<ClsPedido> PedidosEmAberto { get; set; } = new List<ClsPedido>();
    #endregion

    #region Funções de Enventos de Página
    protected override async Task OnInitializedAsync()
    {
        try
        {
            PedidosService.PedidoRecebido += async pedido =>
            {
                await InvokeAsync(() => OnPedidoRecebido(pedido));
            };

            PedidosService.PedidoMudouEtapa += async pedido =>
           {
               await InvokeAsync(() => OnEtapaPedidoMudou(pedido));
           };

            await CarregarPedidos();

            try
            {
                await Connect();
            }
            catch (Exception)
            {
                Snackbar.Add("Erro em criar conexão em tempo real com o servidor, por favor atualize a página", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Erro ao carregar pedidos: " + ex.Message, Severity.Error);
        }
    }

    private async Task OnEtapaPedidoMudou(ClsPedido novoPedido)
    {
        await CarregarPedidos();
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("interceptFunctionKeys", DotNetObjectReference.Create(this));
        }
    }


    private async Task HandleKeyDownGestaoPedidos(KeyboardEventArgs e)
    {
        try
        {
            if (e.CtrlKey && e.AltKey)
            {

            }

            if (e.Key == "F2")
            {
                await AbrirCriacaoDePedido(TiposDePedido.DELIVERY);
            }
            if (e.Key == "F3")
            {
                await AbrirCriacaoDePedido(TiposDePedido.BALCAO);
            }
            if (e.Key == "F1")
            {
                await AbrirCriacaoDePedido(TiposDePedido.MESA);
            }

        }
        catch (Exception ex) when (ex.Message.Contains("out of range", StringComparison.OrdinalIgnoreCase))
        {
            Snackbar.Add("Forma de pagamento não encontrada para a tecla pressionada.", Severity.Error);
        }


    }

    private async Task OnPedidoRecebido(ClsPedido novoPedido)
    {
        await CarregarPedidos();
        await InvokeAsync(StateHasChanged);
        Snackbar.Add("Novo pedido recebido!", Severity.Info);
        await JS.InvokeVoidAsync("playNotificationSound");
    }

    private void OnExpandCollapseClick(ClsDeSuporteParaMostrarPedidos sup)
    {
        sup.Expandido = !sup.Expandido;
    }


    private async void SelecionaPedidosParaProximaEtapaNoCabecalho(ClsDeSuporteParaVizualicacaoDePedidos etapa)
    {
        var pedidosNaEtapa = _items.Where(p => p.Selector == etapa.Selector).ToList();

        foreach (var pedido in pedidosNaEtapa)
        {
            if (!ItensSelecionadosPArAProximaEtapa.Contains(pedido))
            {
                ItensSelecionadosPArAProximaEtapa.Add(pedido);
                pedido.Selecionado = true;
            }
            else
            {
                ItensSelecionadosPArAProximaEtapa.Remove(pedido);
                pedido.Selecionado = false;
            }
        }
    }

    private async Task AbrirCriacaoDePedido(TiposDePedido? tipoDePedido = TiposDePedido.BALCAO, ClsPedido? PedidoAberto = null)
    {
        if (AppState.CaixaAberto)
        {
            var parameters = new DialogParameters
             {
                 { "TiposDePedido", tipoDePedido },
                 { "Mesa",  new ClsMesasEComandas { Id = 0,CodigoExterno = 0} }
             };

            if (PedidoAberto is not null)
            {
                parameters.Add("NovoPedido", PedidoAberto);
                PedidosEmAberto.Remove(PedidoAberto);


                if (PedidoAberto.TipoDePedido == "DELIVERY")
                {
                    parameters["TiposDePedido"] = TiposDePedido.DELIVERY;
                }
                else if (PedidoAberto.TipoDePedido == "BALCÂO")
                {
                    parameters["TiposDePedido"] = TiposDePedido.BALCÃO;
                }
                else if (PedidoAberto.TipoDePedido == "MESA")
                {
                    parameters["TiposDePedido"] = TiposDePedido.MESA;
                }
            }

            var options = new DialogOptions { MaxWidth = MaxWidth.False, FullWidth = false, FullScreen = false, CloseOnEscapeKey = false, BackdropClick = false };

            var dialog = await DialogService.ShowAsync<ModalDeCriarPedido>("Cadastrar Pedido", parameters, options);
            var result = await dialog.Result;

            if (!result!.Canceled && result.Data is bool sucesso && sucesso)
            {
                Carregando = true;
                await CarregarPedidos();
                await InvokeAsync(StateHasChanged);
                Carregando = false;
            }
            else if (result.Data is ClsPedido Pedido)
            {
                PedidosEmAberto.Add(Pedido);
                StateHasChanged();
            }

        }
        else
        {
            var parameters = new DialogParameters<ModalDeAcessoNegado>
            {
                  { x => x.ContentText, $"Caixa está fechado, não é possivel criar pedidos." },
                  { x => x.ButtonText, "OK" },
                  { x => x.Color, Color.Success}
             };
            var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraExtraLarge, FullWidth = true, Position = DialogPosition.BottomLeft, CloseOnEscapeKey = true };
            var dialog = await DialogService.ShowAsync<ModalDeAcessoNegado>("Acesso Negado", parameters, options);
            var result = await dialog.Result;
        }
    }


    private async Task AbreModalDeCodigoDeBarrasParaProximaEtapa()
    {
        if (AppState.CaixaAberto)
        {

            var options = new DialogOptions { MaxWidth = MaxWidth.False, FullWidth = false, FullScreen = false, CloseOnEscapeKey = true, BackdropClick = false };

            var dialog = await DialogService.ShowAsync<ModalDeInputParaMudancaDeEtapaDoPedidoPorCodBarras>("Código De Barras Para Enviar pedido para Proxima Etapa", options);
            var result = await dialog.Result;


        }
        else
        {
            var parameters = new DialogParameters<ModalDeAcessoNegado>
            {
                  { x => x.ContentText, $"Caixa está fechado, não é possivel interagir com pedidos." },
                  { x => x.ButtonText, "OK" },
                  { x => x.Color, Color.Success}
             };
            var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraExtraLarge, FullWidth = true, Position = DialogPosition.BottomLeft, CloseOnEscapeKey = true };
            var dialog = await DialogService.ShowAsync<ModalDeAcessoNegado>("Acesso Negado", parameters, options);
            var result = await dialog.Result;
        }
    }

    //função de close do chip
    void Closed(MudChip<ClsPedido> chip)
    {
        if (chip.Value is not null)
        {
            PedidosEmAberto.Remove(chip.Value);
            StateHasChanged();
        }
    }
    #endregion

    #region Funções Auxiliares
    public async Task CarregarPedidos()
    {
        try
        {
            var result = await PedidosService.GetPedidosPorPaginaAsync(new QuerysDePedidos() { Pesquisa = pesquisaTexto, TipoPedido = FiltroPorTipoDePedido });

            if (result?.Data?.Any() == true)
            {
                _items = result.Data.Select(p => new ClsDeSuporteParaMostrarPedidos
                {
                    Pedido = p,
                    Selector = p.EtapaPedido
                }).ToList();
            }
            else
            {
                Snackbar.Add("Nenhum pedido encontrado.", Severity.Warning);
            }
        }
        catch (Exception)
        {
            Snackbar.Add("Nenhum pedido encontrado.", Severity.Warning);
        }
        finally
        {
            Carregando = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnFiltroChanged(TiposDePedido novoValor)
    {
        FiltroPorTipoDePedido = novoValor;
        await CarregarPedidos();
    }


    private async Task MudaEtapaDoPedido(ClsDeSuporteParaMostrarPedidos? Supor = null)
    {
        try
        {
            CarregandoParteFiscal = true;
            List<ClsDeSuporteParaMostrarPedidos> ListaDePedidos = new List<ClsDeSuporteParaMostrarPedidos>();

            if (Supor is not null)
            {
                ListaDePedidos.Add(Supor);
            }
            else if (ItensSelecionadosPArAProximaEtapa.Count > 0)
            {
                ListaDePedidos.AddRange(ItensSelecionadosPArAProximaEtapa);
                ItensSelecionadosPArAProximaEtapa.Clear();
            }

            await AtualizaPedidosEtapa(ListaDePedidos, Supor);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao atualizar etapa do pedido", Severity.Error);
        }
        finally
        {
            CarregandoParteFiscal = false;
        }

    }

    private async Task AtualizaPedidosEtapa(List<ClsDeSuporteParaMostrarPedidos> ListaDePedidos, ClsDeSuporteParaMostrarPedidos? Supor = null)
    {
        foreach (var item in ListaDePedidos)
        {
            if (item.Selector == "NOVO")
            {
                item.Selector = "PREPARANDO";
                var Response = await PedidosService.UpdatePedidoPreparando(item.Pedido);
                MostraMensagemDeUpdateDoPedido(Response);
                await InvokeAsync(StateHasChanged);
                return;
            }

            if (item.Selector == "PREPARANDO")
            {
                item.Selector = "DESPACHADO"; // Exemplo de mudança de etapa
                var Response = await PedidosService.UpdatePedidoDespachadoEPronto(item.Pedido);
                MostraMensagemDeUpdateDoPedido(Response);
                await InvokeAsync(StateHasChanged);
                return;
            }

            if (item.Selector == "DESPACHADO")
            {
                item.Selector = "FINALIZADO";
                item.UltimaEtapa = true;
                var Response = await PedidosService.UpdatePedidoFinalizadoo(item.Pedido);
                MostraMensagemDeUpdateDoPedido(Response);
                await InvokeAsync(StateHasChanged);
                return;
            }

            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task AvisarNovamenteMesmoPedido(ClsPedido pedido)
    {
        var Response = await PedidosService.UpdatePedidoDespachadoEPronto(pedido);
        MostraMensagemDeUpdateDoPedido(Response);
    }

    private void MostraMensagemDeUpdateDoPedido<T>(ReturnApiRefatored<T> response)
    {
        var message = response.Status == "error"
            ? string.Join(", ", response.Messages)
            : string.Join(", ", response.Data?.Messages ?? new List<string>());

        var severity = response.Status == "error"
            ? Severity.Error
            : Severity.Success;

        Snackbar.Add(message, severity);
    }

    private async Task CancelarPedido(ClsPedido pedido)
    {
        var parameters = new DialogParameters<ModalDeExcluir>
                {
                  { x => x.ContentText, "Atenção: ao excluir este pedido, essa ação não poderá ser desfeita. O estoque será reincorporado automaticamente. Deseja continuar?" },
                    { x => x.ButtonText, "Sim" },
                    { x => x.Color, Color.Error}
                };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Large, CloseOnEscapeKey = true };
        var dialog = await DialogService.ShowAsync<ModalDeExcluir>("Confirmar Emissão", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled && result.Data is bool sucesso && sucesso)
        {
            var Response = await PedidosService.CancelarPedido(pedido);

            if (Response.Status == "success")
            {
                pedido.StatusPedido = "CANCELADO";
            }

            MostraMensagemDeUpdateDoPedido(Response);
            await InvokeAsync(StateHasChanged);
        }
    }

    public class ClsDeSuporteParaVizualicacaoDePedidos
    {
        public string NomeDaEtapa = string.Empty;
        public string Selector { get; set; } = "1";
    }


    private async Task OnPesquisaChanged(string value)
    {
        pesquisaTexto = value;
        await BuscarPedidos(); // atualiza a lista conforme digita
    }

    private async Task BuscarPedidos()
    {
        await CarregarPedidos();
    }

    private async Task VerificaStatusDeNFCe()
    {
        try
        {
            CarregandoParteFiscal = true;

            var response = await NFService.VerificaStatusServicoNFCe();
            MostraMensagemDeUpdateDoPedido(response);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{ex.Message}", Severity.Error);
        }
        finally
        {
            CarregandoParteFiscal = false;
        }
    }


    //Simula progresso de emissão fiscal
    int ProgressoFiscal = 0;
    CancellationTokenSource? _progressCts;
    private async Task SimulaProgressoAsync(CancellationToken token)
    {
        ProgressoFiscal = 0;

        while (ProgressoFiscal < 90 && !token.IsCancellationRequested)
        {
            await Task.Delay(600, token);
            ProgressoFiscal += Random.Shared.Next(2, 6);
            ProgressoFiscal = Math.Min(ProgressoFiscal, 98);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task EmiteNFCe(ClsPedido Pedido)
    {
        ProgressoFiscal = 0;
        _progressCts = new CancellationTokenSource();

        StateHasChanged();
        try
        {
            var EnvNFCeDto = new EnNfCeDto
            {
                Pedido = Pedido
            };

            var parameters = new DialogParameters<ModalDeCpfNaNota>
            {
                 { x => x.enNfCeDto, EnvNFCeDto  }
             };

            var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraExtraLarge, FullWidth = true, Position = DialogPosition.Center, CloseOnEscapeKey = true };
            var dialog = await DialogService.ShowAsync<ModalDeCpfNaNota>("Informações Adicionais", parameters, options);
            var result = await dialog.Result;

            if (!result!.Canceled)
            {
                CarregandoParteFiscal = true;

                _ = SimulaProgressoAsync(_progressCts.Token);

                var response = await NFService.GeraNFCe(EnvNFCeDto);
                MostraMensagemDeUpdateDoPedido(response);


                //baixar o xml e o pdf se sucesso
                if (response.Status != "error")
                {
                    if (response.Data.ObjetoWhenWriting is not null && response.Data.ObjetoWhenWriting.XmlStringField is not null)
                        await JS.InvokeVoidAsync("baixarXMLNF", response.Data.ObjetoWhenWriting.XmlStringField, $"{response.Data.ObjetoWhenWriting.ChaveNf}-procnfe.xml");

                }
            }
            else
            {
                Snackbar.Add("Emissão de NFC-e cancelada pelo usuário.", Severity.Info);
            }


        }
        catch (Exception ex)
        {
            Snackbar.Add($"{ex.Message}", Severity.Error);
        }
        finally
        {
            CarregandoParteFiscal = false;
            _progressCts?.Cancel();
            ProgressoFiscal = 100;
            await Task.Delay(300); // efeito visual
            CarregandoParteFiscal = false;
            StateHasChanged();
        }
    }
    #endregion

    #region Funções de Impressão e WebSocket
    private async Task Connect()
    {
        await JS.InvokeVoidAsync("socketIO.connectSocketIO", "https://syslogicadev.com/api/v1/");
        status = "Conectado";
    }

    private async Task ImprimirPedido(ClsPedido pedido)
    {
        bool ImpressaoDesabilita = await LocalStorage.GetItemAsync<bool?>("ImpressaoDesabilita") ?? false;

        if (!ImpressaoDesabilita)
            await JS.InvokeVoidAsync("baixarJSON", pedido, $"pedido{pedido.Id}-SOPHOS-WEB.json");
        else
            Snackbar.Add("Impressão desabilitada nas configurações.", Severity.Warning);
    }
    #endregion

    #region Funções de edicao do pedido
    private async Task EditarPedido(ClsPedido pedido)
    {
        //Primeiro fazer a requisição para ver se existe pagamentos para ser editado
        ReturnApiRefatored<PagamentoDoPedido> ReturnFromApi = await CaixasService.GetPagamentosDoPedidoAsync(pedido);
        MostraMensagemDeUpdateDoPedido(ReturnFromApi);
        if (ReturnFromApi.Status == "eror")
            return;

        pedido.Pagamentos = ReturnFromApi.Data?.Lista ?? pedido.Pagamentos;
        var parameters = new DialogParameters
         {
             { "Pedido", pedido },
             {"Editando", true}
         };

        var options = new DialogOptions
        {
            Position = DialogPosition.Center,
            CloseButton = false,
            BackdropClick = false,
            MaxWidth = MaxWidth.False,
            FullWidth = true,
            CloseOnEscapeKey = false
        };

        var dialog = await DialogService.ShowAsync<ModalDePagamento>("Pagamento", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled && result.Data is bool sucesso && sucesso)
        {

        }

    }
    #endregion
}
