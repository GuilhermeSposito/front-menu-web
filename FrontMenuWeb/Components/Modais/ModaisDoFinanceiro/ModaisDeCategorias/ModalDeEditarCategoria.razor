@rendermode RenderMode.InteractiveWebAssembly
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using FrontMenuWeb.Models.Financeiro
@using FrontMenuWeb.Services
@using FrontMenuWeb.Services.FinanceroServices
@using System.Globalization
@inject CategoriasService CategoriasService


<MudPaper Square="false" Elevation="0">
    <MudDialog class="rounded-3 w-100" style="background-color: var(--mud-palette-surface);">
        <DialogContent>
            @if (!CarregandoCategoria && CategoriaParaEdicao is not null)
            {
                <MudForm @onkeydown="HandleKeyDown" class="" Spacing="5" @onsubmit="Submit">
                    <MudFocusTrap DefaultFocus="DefaultFocus.FirstChild">

                        <MudTextField @bind-Value=@CategoriaParaEdicao.Descricao Variant="Variant.Filled" Required RequiredError="A descrição é obrigatória" />



                        <div>
                            @if (ErroAoAdicionarCategoria)
                            {
                                <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mt-2">
                                    @MensagemDeErro
                                </MudAlert>
                            }
                        </div>
                    </MudFocusTrap>
                </MudForm>

            }
            else
            {
                <MudSkeleton Class="w-100"
                             Height="120px" />

            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="Cancelar">Cancelar</MudButton>
            <MudButton style="color: #F88113" OnClick="Submit">Adicionar</MudButton>
        </DialogActions>
    </MudDialog>
</MudPaper>


@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }
    private MudTextField<string> _descricaoRef;

    private bool CarregandoCategoria = true;

    private bool ErroAoAdicionarCategoria = false;
    private string MensagemDeErro = "Erro ao modificada a categoria. Verifique os dados e tente novamente.";
    public CultureInfo _pt = CultureInfo.GetCultureInfo("pt-BR");

    [Parameter] public int IdCategoria { get; set; }
    public ClsCategoria? CategoriaParaEdicao { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {

            CategoriaParaEdicao = await CategoriasService.GetCategoriaAsync(IdCategoria);
            if (CategoriaParaEdicao is null)
            {
                MensagemDeErro = "Categoria não encontrada.";
                ErroAoAdicionarCategoria = true;
                Snackbar.Add(MensagemDeErro, Severity.Error);
            }

        }
        catch (Exception ex)
        {
            CarregandoCategoria = false;
            MensagemDeErro = $"Erro ao carregar a categoria: {ex.Message}";
            ErroAoAdicionarCategoria = true;
            Snackbar.Add(MensagemDeErro, Severity.Error);
        }
        finally
        {
            CarregandoCategoria = false;
        }
    }

    private async Task Submit()
    {
        try
        {
            var retornoDaApi = await CategoriasService.UpdateCategoriaAsync(CategoriaParaEdicao);

            if (retornoDaApi is not null)
            {
                if (retornoDaApi.Status == "success")
                {
                    Snackbar.Add("Categoria modificada com sucesso!", Severity.Success);
                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    string mensagemDeErroDaAPi = string.Join(", ", retornoDaApi.Messages);
                    MensagemDeErro = $"Erro ao modificada a categoria: {mensagemDeErroDaAPi}";
                    ErroAoAdicionarCategoria = true;
                    Snackbar.Add(MensagemDeErro, Severity.Error);
                }
            }
            else
            {
                MensagemDeErro = "Erro ao modificada a categoria. Verifique os dados e tente novamente.";
                ErroAoAdicionarCategoria = true;
            }

        }
        catch (Exception ex)
        {
            MensagemDeErro = "Erro ao modificada a categoria. Verifique os dados e tente novamente.";
            ErroAoAdicionarCategoria = true;
            Snackbar.Add($"Erro ao modificada categoria: {ex.Message}", Severity.Error);
        }

    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Submit();
        }
    }

    private void Cancelar()
    {
        MudDialog.Cancel();
    }



}
