@rendermode RenderMode.InteractiveWebAssembly
@attribute [Authorize]
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using FrontMenuWeb.Components.Modais.ModaisDePessoas
@using FrontMenuWeb.Models.EntregaMachine
@using FrontMenuWeb.Models.Financeiro
@using FrontMenuWeb.Models.Merchant
@using FrontMenuWeb.Models.Pessoas
@using FrontMenuWeb.Services
@using FrontMenuWeb.Services.FinanceroServices
@using System.Globalization
@using FrontMenuWeb.Services.ServicosDeTerceiros
@inject IJSRuntime JS
@inject EntregasMachineService EntregasMachineService

<MudPaper Square="false" Elevation="0">
    <MudDialog class="rounded-3 w-100" style="background-color: var(--mud-palette-surface);">
        <DialogContent>
            <MudGrid>
                <MudItem xs="12" sm="12" md="12" lg="12">
                    <MudTextField @bind-Value="Empresa.Nome" Label="Nome da Empresa" Variant="Variant.Outlined" FullWidth="true" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="12" md="12" lg="12">
                    <MudTextField @bind-Value="Empresa.EmailEmpresaIntegrada" Label="Email do Estabelecimento" Variant="Variant.Outlined" FullWidth="true" Required="true" />
                </MudItem>
                @if (ECriacao)
                {
                    <MudItem xs="12" sm="12" md="12" lg="12">
                        <MudTextField Class="w-50" T="string" Label="Senha" HelperText="Escolha uma senha forte"
                                      @bind-Value=Empresa.SenhaEmpresaIntegrada
                                      InputType="InputType.Password"
                                      Required="true"
                                      RequiredError="Senha é obrigatória"
                                      Variant="Variant.Filled"
                                      Immediate=true />
                    </MudItem>
                }
                <MudItem xs="6" sm="6" md="6" lg="5">
                    <MudTextField @bind-Value="Empresa.TipoPagamento" MaxLength=1 Label="Tipo Do Pagamento" Variant="Variant.Outlined" FullWidth="true" Required="true" Style="text-transform: uppercase;" />
                </MudItem>
                <MudItem xs="6" sm="6" md="6" lg="5">
                    <MudSelect Class="w-100 h-100" T="int" @bind-Value=Empresa.CodEmpresa>
                        <MudSelectItem Value="3">ÁPICE</MudSelectItem>
                        <MudSelectItem Value="4">Del Match</MudSelectItem>
                        <MudSelectItem Value="2">OTTO</MudSelectItem>
                        <MudSelectItem Value="1">JUMA</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="Cancelar">Cancelar</MudButton>
            <MudButton Color="Color.Primary" OnClick="Submit">@(ECriacao ? "Adicionar" : "Atualizar")</MudButton>
        </DialogActions>
    </MudDialog>
</MudPaper>


@code {
    #region Injeções de Dependência
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }
    public CultureInfo _pt = CultureInfo.GetCultureInfo("pt-BR");
    #endregion

    #region Props
    private string MensagemDeErro = string.Empty;
    private bool CarregandoFuncionario = true;

    [Parameter] public bool ECriacao { get; set; }
    [Parameter] public EmpresaMachine Empresa { get; set; } = new EmpresaMachine();
    #endregion

    private async Task Submit()
    {
        try
        {
            Empresa.TipoPagamento = Empresa.TipoPagamento.ToUpperInvariant();
            ReturnApiRefatored<EmpresaMachine> ReturnApi = new();

            if (ECriacao)
            {
                Console.WriteLine("Criando nova empresa...");
                ReturnApi = await EntregasMachineService.CreateEmpresa(Empresa);
            }
            else
            {
                ReturnApi = await EntregasMachineService.EditEmpresa(Empresa);
            }

            bool adicionou = ReturnApi.Status == "success";
            string Mensagem = adicionou ? string.Join(",", ReturnApi.Data.Messages) : string.Join(",", ReturnApi.Messages);
            Snackbar.Add(Mensagem, adicionou ? Severity.Success : Severity.Error);

            if (adicionou)
            {
                MudDialog.Close(DialogResult.Ok(true));
            }

        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao adicionar funcionário: {ex.Message}", Severity.Error);
        }

    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Submit();
        }
    }

    private void Cancelar()
    {
        MudDialog.Cancel();
    }



}

